# OpenCTI Deployment Guide

This guide covers deploying OpenCTI using the corrected Helm configuration that resolves common initialization issues.

## Quick Start

```bash
# Deploy OpenCTI
bash k8s/opencti/install-opencti.sh

# If initialization fails (schema/policy errors)
bash k8s/opencti/opensearch-reset.sh opencti
kubectl delete pods -l opencti.component=server -n opencti

# Bootstrap admin credentials
bash k8s/opencti/bootstrap-admin.sh opencti
```

## Files Overview

- **`values-fixed.yaml`**: Corrected Helm values with proper MinIO endpoint configuration
- **`install-opencti.sh`**: Deployment script with credential validation  
- **`bootstrap-admin.sh`**: Generates valid admin credentials (UUIDv4 token)
- **`opensearch-reset.sh`**: Recovers from failed OpenSearch initialization

## Key Configuration Fixes

### MinIO Endpoint Configuration

**Problem**: OpenCTI expects `MINIO__ENDPOINT` to be hostname only, but values included full URL.

**Solution**:
```yaml
# ❌ Wrong (was causing "Invalid URL" errors)
- name: MINIO__ENDPOINT
  value: "http://opencti-minio:9000"

# ✅ Correct
- name: MINIO__ENDPOINT
  value: "opencti-minio"  # hostname only
- name: MINIO__PORT
  value: "9000"           # port separate
```

### Service Name Alignment

**Problem**: OpenCTI was configured with placeholder service names that didn't match actual Helm chart outputs.

**Solution**:
```yaml
# Service names must match what Helm chart creates
- name: RABBITMQ__HOSTNAME
  value: "opencti-rabbitmq"    # not "release-name-rabbitmq"
- name: REDIS__HOSTNAME  
  value: "opencti-redis"       # not "release-name-redis-master"
```

### Admin Credentials

**Problem**: Default values cause initialization failure.

**Requirements**:
- `APP__ADMIN__PASSWORD` **cannot** be `"ChangeMe"`
- `APP__ADMIN__TOKEN` **must** be valid UUIDv4 format

**Solution**: Use `bootstrap-admin.sh` to generate proper credentials.

### MinIO Credential Sync

**Problem**: MinIO secret and OpenCTI environment variables had mismatched credentials.

**Solution**: Install script validates and aligns credentials:
```bash
# Expected in values-fixed.yaml
minio:
  auth:
    rootUser: opencti
    rootPassword: "MinIO2024!"

# Must match OpenCTI env vars
MINIO__ACCESS_KEY: "opencti"
MINIO__SECRET_KEY: "MinIO2024!"
```

## Deployment Process

### 1. Initial Deployment

```bash
# Creates namespace, deploys charts, validates credentials
bash k8s/opencti/install-opencti.sh
```

This script:
- Adds Helm repository
- Creates `opencti` namespace
- Deploys using `values-fixed.yaml` 
- Validates MinIO credentials match values
- Restarts MinIO if credentials drift
- Bootstraps admin credentials

### 2. Monitor Initialization

```bash
# Watch pods come up
kubectl get pods -n opencti -w

# Monitor server logs
kubectl logs -f deployment/opencti-server -n opencti
```

Look for these success indicators:
- ✅ `[CHECK] Search engine ok`
- ✅ `[CHECK] File storage ok` 
- ✅ `[CHECK] RabbitMQ ok`
- ✅ `[CHECK] Redis ok`
- ✅ `[INIT] Platform initialization done`
- ✅ HTTP server ready messages

### 3. Access OpenCTI

Once deployed:
- **URL**: https://opencti.ozzu.world
- **Credentials**: Set in `values-fixed.yaml` or generated by bootstrap script

## Troubleshooting

### Common Errors and Solutions

#### MinIO Authentication Errors

**Symptoms**:
```
InvalidAccessKeyId: The Access Key Id you provided does not exist
SignatureDoesNotMatch: The request signature we calculated does not match
```

**Cause**: MinIO secret credentials don't match OpenCTI environment variables.

**Solution**:
```bash
# Check current MinIO secret
kubectl get secret opencti-minio -n opencti --template='{{range $key, $value := .data}}{{printf "%s: %s\n" $key ($value | base64decode)}}{{end}}'

# Fix credentials to match values-fixed.yaml
kubectl patch secret opencti-minio -n opencti --type='json' -p='[
  {"op":"replace","path":"/data/rootUser","value":"'$(echo -n "opencti" | base64)'"},
  {"op":"replace","path":"/data/rootPassword","value":"'$(echo -n "MinIO2024!" | base64)'"}
]'

# Restart MinIO and OpenCTI
kubectl delete pod -l app=minio -n opencti
kubectl delete pods -l opencti.component=server -n opencti
```

#### RabbitMQ Connection Errors

**Symptoms**:
```
getaddrinfo ENOTFOUND release-name-rabbitmq
```

**Cause**: Wrong service hostname in environment variables.

**Solution**: Ensure `values-fixed.yaml` has correct service names and redeploy.

#### OpenSearch Initialization Failures

**Symptoms**:
```
Fail initialize schema, index already exists, previous initialization fail
version_conflict_engine_exception: [opencti-ism-policy]: document already exists
```

**Cause**: Corrupted indices/policies from previous failed initialization.

**Solution**:
```bash
# Reset OpenSearch
bash k8s/opencti/opensearch-reset.sh opencti

# Restart OpenCTI server
kubectl delete pods -l opencti.component=server -n opencti
```

#### Admin User Configuration Errors

**Symptoms**:
```
You need to configure the environment vars
```

**Cause**: Invalid admin password ("ChangeMe") or token (not UUIDv4).

**Solution**:
```bash
# Generate proper admin credentials
bash k8s/opencti/bootstrap-admin.sh opencti
```

### OpenSearch Attachment Processor Warning

**Message**:
```
Engine attachment processor configuration fail
```

**Status**: ⚠️ **Harmless** - This is expected and doesn't prevent OpenCTI from running. The attachment processor is not required for basic functionality.

## Manual Operations

### Reset Everything

```bash
# Complete cleanup
bash k8s/opencti/install-opencti.sh --cleanup

# Fresh deployment  
bash k8s/opencti/install-opencti.sh
```

### Check Deployment Status

```bash
bash k8s/opencti/install-opencti.sh --status
```

### View Logs

```bash
bash k8s/opencti/install-opencti.sh --logs
```

### OpenSearch Reset Only

```bash
bash k8s/opencti/opensearch-reset.sh opencti
```

## Configuration Requirements

### Environment Variable Constraints

1. **MinIO Configuration**:
   - `MINIO__ENDPOINT`: Hostname only (no protocol/port)
   - `MINIO__ACCESS_KEY` & `MINIO__SECRET_KEY`: Must match MinIO secret
   - `MINIO__USE_SSL`: "false" for internal communication

2. **Admin Configuration**:
   - `APP__ADMIN__PASSWORD`: Cannot be "ChangeMe"
   - `APP__ADMIN__TOKEN`: Must be valid UUIDv4
   - `APP__ADMIN__EMAIL`: Valid email format

3. **Service Hostnames**:
   - `RABBITMQ__HOSTNAME`: "opencti-rabbitmq"
   - `REDIS__HOSTNAME`: "opencti-redis"
   - `ELASTICSEARCH__URL`: "http://opensearch-cluster-master:9200"

### Persistent Storage

All services use `local-storage` storage class:
- OpenSearch: 20Gi
- MinIO: 50Gi  
- Redis: 5Gi
- RabbitMQ: 10Gi

## Security Notes

⚠️ **Production Considerations**:

1. **Change Default Passwords**: Update all passwords in `values-fixed.yaml`
2. **TLS Certificates**: Configure proper SSL certificates for ingress
3. **RBAC**: Review Kubernetes RBAC permissions
4. **Network Policies**: Implement network segmentation
5. **Secrets Management**: Use external secret management (Vault, etc.)
6. **Admin Token**: Store admin token securely, rotate regularly

## Architecture

```
[Ingress] → [OpenCTI Server] → [Worker]
     ↓              ↓           ↓
[OpenSearch]    [MinIO]    [RabbitMQ]
     ↓              ↓           ↓  
 [Redis]       [Storage]   [Queues]
```

All components run in the `opencti` namespace with persistent storage and proper service discovery.
