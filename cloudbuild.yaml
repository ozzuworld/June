substitutions:
  _REGION: us-central1
  _REPO: june
  _TF_DIR: June/infra
  _FIREBASE_PROJECT_ID: ${PROJECT_ID}

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Ensure Artifact Registry repo exists (idempotent)
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: ensure-artifact-registry
    entrypoint: bash
    args:
      - -c
      - |
        set -euo pipefail
        if ! gcloud artifacts repositories describe "${_REPO}" --location="${_REGION}" >/dev/null 2>&1; then
          gcloud artifacts repositories create "${_REPO}"             --repository-format=docker             --location="${_REGION}"             --description="Docker repo for June microservices"
        else
          echo "Artifact Registry ${_REPO} exists"
        fi

  # Build & push images
  - name: gcr.io/cloud-builders/docker
    id: build-orchestrator
    dir: June/services/june-orchestrator
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-orchestrator:$SHORT_SHA
      - .

  - name: gcr.io/cloud-builders/docker
    id: push-orchestrator
    args: ["push", "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-orchestrator:$SHORT_SHA"]

  - name: gcr.io/cloud-builders/docker
    id: build-stt
    dir: June/services/june-stt
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-stt:$SHORT_SHA
      - .

  - name: gcr.io/cloud-builders/docker
    id: push-stt
    args: ["push", "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-stt:$SHORT_SHA"]

  - name: gcr.io/cloud-builders/docker
    id: build-tts
    dir: June/services/june-tts
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-tts:$SHORT_SHA
      - .

  - name: gcr.io/cloud-builders/docker
    id: push-tts
    args: ["push", "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-tts:$SHORT_SHA"]

  - name: gcr.io/cloud-builders/docker
    id: build-june-auth
    dir: June/services/june-auth
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-auth:$SHORT_SHA
      - .

  - name: gcr.io/cloud-builders/docker
    id: push-june-auth
    args: ["push", "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-auth:$SHORT_SHA"]

  # Terraform init/plan/apply
  - name: hashicorp/terraform:1.8
    id: terraform-init
    dir: ${_TF_DIR}
    entrypoint: sh
    args:
      - -c
      - |
        set -euo pipefail
        terraform --version
        terraform init -input=false           -backend-config="bucket=${PROJECT_ID}-tfstate"           -backend-config="prefix=state"

  - name: hashicorp/terraform:1.8
    id: terraform-apply
    dir: ${_TF_DIR}
    entrypoint: sh
    args:
      - -c
      - |
        set -euo pipefail
        export TF_IN_AUTOMATION=1
        terraform apply -auto-approve -input=false           -var="project_id=$PROJECT_ID"           -var="region=${_REGION}"           -var="repo_name=${_REPO}"           -var="firebase_project_id=${_FIREBASE_PROJECT_ID}"           -var="orchestrator_image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-orchestrator:$SHORT_SHA"           -var="stt_image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-stt:$SHORT_SHA"           -var="tts_image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-tts:$SHORT_SHA"           -var="june_auth_image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/june-auth:$SHORT_SHA"

