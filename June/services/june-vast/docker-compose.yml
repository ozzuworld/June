version: "3.9"

services:
  # ==========================================
  # STT Service (Speech-to-Text)
  # ==========================================
  june-stt:
    image: ozzuworld/june-stt:latest
    container_name: june-stt
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: ["gpu"]
              device_ids: ["0"]  # single GPU 0
    environment:
      - PYTHONUNBUFFERED=1
      - LIVEKIT_IDENTITY=june-stt
      - LIVEKIT_ROOM=ozzu-main
      - ORCHESTRATOR_URL=https://api.ozzu.world
      - CUDA_VISIBLE_DEVICES=0
    ports:
      - "8001:8001"
    volumes:
      - stt-cache:/root/.cache
    networks:
      - june-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # TTS Service (Text-to-Speech)
  # ==========================================
  june-tts:
    image: ozzuworld/june-tts:latest
    container_name: june-tts
    restart: unless-stopped
     #uncomment this block ONLY if june-tts image really needs GPU
    deploy:
       resources:
         reservations:
           devices:
             - driver: nvidia
               capabilities: ["gpu"]
               device_ids: ["0"]  # share GPU 0
    environment:
      # set whatever your TTS image actually uses; example:
      - HF_TOKEN=${HF_TOKEN:-}
      - REFERENCES_DIR=/app/references
      - FISH_SPEECH_TIMEOUT=180
    volumes:
      - ./services/june-tts/references:/app/references
      - tts-cache:/root/.cache
    ports:
      - "8000:8000"
    networks:
      - june-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  june-network:
    driver: bridge
    name: june-network

volumes:
  stt-cache:
    name: june-stt-cache
  tts-cache:
    name: june-tts-cache
