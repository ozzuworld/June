steps:
  # Build the orchestrator image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:$SHORT_SHA',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:latest',
      '-f', 'Dockerfile',
      '.'
    ]
    timeout: '1800s'

  # Push to your existing Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:$SHORT_SHA']
    timeout: '900s'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:latest']
    timeout: '900s'

  # Tag for Docker Hub
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'tag',
      'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:latest',
      'ozzuworld/june-orchestrator:latest'
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'tag',
      'us-central1-docker.pkg.dev/$PROJECT_ID/june/june-orchestrator:$SHORT_SHA',
      'ozzuworld/june-orchestrator:$SHORT_SHA'
    ]

  # Login to Docker Hub
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "$$DOCKERHUB_TOKEN" | docker login --username $$DOCKERHUB_USERNAME --password-stdin
    secretEnv: ['DOCKERHUB_USERNAME', 'DOCKERHUB_TOKEN']

  # Push to Docker Hub
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'ozzuworld/june-orchestrator:latest']
    timeout: '900s'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'ozzuworld/june-orchestrator:$SHORT_SHA']
    timeout: '900s'

# Access your Docker Hub secrets
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/dockerhub-username/versions/latest
      env: 'DOCKERHUB_USERNAME'
    - versionName: projects/$PROJECT_ID/secrets/dockerhub-token/versions/latest
      env: 'DOCKERHUB_TOKEN'

# Standard machine for orchestrator
options:
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100
  logging: CLOUD_LOGGING_ONLY
  
timeout: 3600s
