worker_processes auto;

events { worker_connections 1024; }

http {
  absolute_redirect off;

  server {
    listen 0.0.0.0:8080;
    server_name _;

    add_header X-Edge nginx-edge always;

    # Health endpoints
    location = /healthz    { access_log off; add_header Content-Type text/plain; return 200 "ok\n"; }
    location = /health     { access_log off; add_header Content-Type text/plain; return 200 "ok\n"; }
    location = /_ah/health { access_log off; add_header Content-Type text/plain; return 200 "ok\n"; }
    location ^~ /healthz/  { access_log off; add_header Content-Type text/plain; return 200 "ok\n"; }

    # Keycloak (modern Quarkus layout)
    location /realms/ {
      proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
      proxy_ssl_server_name on;
      proxy_set_header Host june-idp-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location /admin/ {
      proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
      proxy_ssl_server_name on;
      proxy_set_header Host june-idp-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Back-compat shim for old Keycloak URLs (/auth/*)
    location /auth/ {
      rewrite ^/auth/(.*)$ /$1 break;
      proxy_pass https://june-idp-359243954.us-central1.run.app;
      proxy_ssl_server_name on;
      proxy_set_header Host june-idp-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Orchestrator
    location /orchestrator/ {
      proxy_pass https://june-orchestrator-359243954.us-central1.run.app/;
      proxy_ssl_server_name on;
      proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # STT (remove if unused)
    location /stt/ {
      proxy_pass https://june-stt-359243954.us-central1.run.app/;
      proxy_ssl_server_name on;
      proxy_set_header Host june-stt-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # TTS (remove if unused)
    location /tts/ {
      proxy_pass https://june-tts-359243954.us-central1.run.app/;
      proxy_ssl_server_name on;
      proxy_set_header Host june-tts-359243954.us-central1.run.app;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Landing page
    location = / { return 302 /realms/june; }
  }
}
