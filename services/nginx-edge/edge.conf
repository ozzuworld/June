# services/nginx-edge/edge.conf
# This file is included inside the stock http {} via: include /etc/nginx/conf.d/*.conf;
# UPDATED: Added Kokoro TTS routing with complete configuration

# (http-level tweaks allowed here)
absolute_redirect off;

# WebSocket upgrade mapping for future use
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 0.0.0.0:8080;
  server_name _;

  # Tag responses so you can see they came from this edge
  add_header X-Edge nginx-edge always;

  # Security headers
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # Client upload limits for TTS/STT
  client_max_body_size 50M;
  client_body_timeout 60s;
  client_header_timeout 60s;

  # ---- Health endpoints (bullet-proof) ----
  location ~ ^/(healthz|health|_ah/health)/?$ {
    access_log off;
    default_type text/plain;
    return 200 "nginx-edge-ok\n";
  }

  # Exact health check (highest precedence)
  location = /healthz {
    access_log off;
    default_type text/plain;
    return 200 "nginx-edge-ok\n";
  }

  # Debug endpoint - shows this config is loaded
  location = /__edge_dump {
    access_log off;
    default_type text/plain;
    return 200 "edge-conf-live:kokoro-v1\nTimestamp: $time_iso8601\n";
  }

  # ---- Keycloak Identity Provider ----
  # Modern Keycloak paths (v18+)
  location /realms/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
  }

  # Keycloak admin console
  location /admin/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
  }

  # Legacy Keycloak path compatibility (/auth/* -> /*)
  location /auth/ {
    rewrite ^/auth/(.*)$ /$1 break;
    proxy_pass https://june-idp-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
  }

  # ---- June Orchestrator Service ----
  location /orchestrator/ {
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Extended timeouts for AI processing
    proxy_read_timeout 300s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    
    # WebSocket support for future use
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
  }

  # ---- Speech-to-Text Service ----
  location /stt/ {
    proxy_pass https://june-stt-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-stt-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # STT-specific timeouts (audio processing can be slow)
    proxy_read_timeout 180s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 180s;
    
    # Large file uploads for audio
    client_max_body_size 100M;
    
    # WebSocket support for streaming STT
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
  }

  # ---- Kokoro TTS Service (Primary TTS) ----
  location /tts/ {
    proxy_pass https://june-kokoro-tts-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-kokoro-tts-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Kokoro-specific timeouts (model inference + audio generation)
    proxy_read_timeout 180s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 180s;
    
    # Buffer settings for streaming audio
    proxy_buffering on;
    proxy_buffer_size 64k;
    proxy_buffers 8 64k;
    proxy_busy_buffers_size 128k;
    
    # Add header to identify Kokoro TTS
    add_header X-TTS-Engine "kokoro" always;
  }

  # ---- Explicit Kokoro TTS path ----
  location /kokoro-tts/ {
    proxy_pass https://june-kokoro-tts-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-kokoro-tts-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Same timeouts as primary TTS
    proxy_read_timeout 180s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 180s;
    
    # Buffer settings for streaming audio
    proxy_buffering on;
    proxy_buffer_size 64k;
    proxy_buffers 8 64k;
    proxy_busy_buffers_size 128k;
    
    add_header X-TTS-Engine "kokoro-explicit" always;
  }

  # ---- Legacy Google TTS (backward compatibility) ----
  location /legacy-tts/ {
    proxy_pass https://june-tts-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-tts-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Standard timeouts for Google TTS
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    
    add_header X-TTS-Engine "google-legacy" always;
  }

  # ---- API Gateway style routes ----
  # Direct API access patterns
  location /api/v1/chat {
    rewrite ^/api/v1/(.*)$ /v1/$1 break;
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
  }

  location /api/v1/process-audio {
    rewrite ^/api/v1/(.*)$ /v1/$1 break;
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
    client_max_body_size 100M;
  }

  # ---- Error pages ----
  error_page 404 /404.html;
  location = /404.html {
    internal;
    default_type text/html;
    return 404 '<!DOCTYPE html>
<html><head><title>404 Not Found</title></head>
<body><h1>404 Not Found</h1><p>The requested resource was not found on this server.</p>
<p><small>nginx-edge/kokoro-v1</small></p></body></html>';
  }

  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    internal;
    default_type text/html;
    return 500 '<!DOCTYPE html>
<html><head><title>Service Unavailable</title></head>
<body><h1>Service Temporarily Unavailable</h1><p>Please try again later.</p>
<p><small>nginx-edge/kokoro-v1</small></p></body></html>';
  }

  # ---- Default/Landing page ----
  location = / {
    return 302 /realms/june;
  }

  # Catch-all for unmatched paths
  location / {
    default_type text/html;
    return 404 '<!DOCTYPE html>
<html><head><title>Path Not Found</title></head>
<body><h1>Path Not Found</h1>
<p>Available endpoints:</p>
<ul>
  <li><a href="/healthz">/healthz</a> - Health check</li>
  <li><a href="/realms/june">/realms/june</a> - Authentication</li>
  <li>/orchestrator/ - AI Orchestrator</li>
  <li>/tts/ - Kokoro Text-to-Speech</li>
  <li>/stt/ - Speech-to-Text</li>
  <li>/legacy-tts/ - Legacy TTS</li>
</ul>
<p><small>nginx-edge/kokoro-v1</small></p>
</body></html>';
  }
}