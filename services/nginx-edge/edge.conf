# services/nginx-edge/edge.conf - FIXED TTS ROUTING
# Complete Nginx configuration with corrected service names

# This file is included inside the stock http {} via: include /etc/nginx/conf.d/*.conf;

# (http-level tweaks allowed here)
absolute_redirect off;

# WebSocket upgrade mapping for future use
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 0.0.0.0:8080;
  server_name _;

  # Tag responses so you can see they came from this edge
  add_header X-Edge nginx-edge always;

  # Security headers
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # Client upload limits for TTS and voice cloning
  client_max_body_size 100M;
  client_body_timeout 120s;
  client_header_timeout 60s;
  send_timeout 120s;

  # ---- Health endpoints (bullet-proof) ----
  location ~ ^/(healthz|health|_ah/health)/?$ {
    access_log off;
    default_type text/plain;
    return 200 "nginx-edge-ok\n";
  }

  # Exact health check (highest precedence)
  location = /healthz {
    access_log off;
    default_type text/plain;
    return 200 "nginx-edge-ok\n";
  }

  # Debug endpoint - shows this config is loaded
  location = /__edge_dump {
    access_log off;
    default_type text/plain;
    return 200 "edge-conf-live:fixed-tts-v1\nTimestamp: $time_iso8601\nTTS-Engine: coqui\n";
  }

  # ---- Keycloak Identity Provider ----
  # Modern Keycloak paths (v18+)
  location /realms/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
    
    # Keycloak session handling
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }

  # Keycloak admin console
  location /admin/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;
  }

  # Legacy Keycloak path compatibility (/auth/* -> /*)
  location /auth/ {
    rewrite ^/auth/(.*)$ /$1 break;
    proxy_pass https://june-idp-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
  }

  # ---- June Orchestrator Service ----
  location /orchestrator/ {
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Extended timeouts for AI processing
    proxy_read_timeout 300s;
    proxy_connect_timeout 15s;
    proxy_send_timeout 300s;
    
    # WebSocket support for real-time features
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
    proxy_http_version 1.1;
    
    # Add orchestrator identification
    add_header X-Service "orchestrator" always;
  }

  # ---- Speech-to-Text Service ----
  location /stt/ {
    proxy_pass https://june-stt-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-stt-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # STT-specific timeouts (audio processing can be slow)
    proxy_read_timeout 180s;
    proxy_connect_timeout 15s;
    proxy_send_timeout 180s;
    
    # Large file uploads for audio
    client_max_body_size 100M;
    
    # WebSocket support for streaming STT
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
    proxy_http_version 1.1;
    
    # Add STT identification
    add_header X-Service "speech-to-text" always;
  }

  # ---- TTS Service (FIXED: Point to june-tts) ----
  location /tts/ {
    proxy_pass https://june-tts-359243954.us-central1.run.app/;  # FIXED: Use june-tts
    proxy_ssl_server_name on;
    proxy_set_header Host june-tts-359243954.us-central1.run.app;  # FIXED: Use june-tts
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    
    # TTS-specific timeouts (model inference + audio generation)
    proxy_read_timeout 300s;
    proxy_connect_timeout 15s;
    proxy_send_timeout 300s;
    
    # Buffer settings optimized for streaming audio
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 8 128k;
    proxy_busy_buffers_size 256k;
    proxy_max_temp_file_size 1024m;
    
    # Large file uploads for voice cloning
    client_max_body_size 100M;
    
    # Add headers to identify TTS service
    add_header X-TTS-Engine "coqui" always;  # FIXED: Use coqui instead of chatterbox
    add_header X-Service "text-to-speech" always;
    add_header X-Features "emotion-control,voice-cloning,multilingual" always;
  }

  # ---- API Gateway style routes ----
  # Direct API access patterns for external integrations
  location /api/v1/chat {
    rewrite ^/api/v1/(.*)$ /v1/$1 break;
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
    proxy_connect_timeout 15s;
    
    add_header X-API-Version "v1" always;
  }

  location /api/v1/process-audio {
    rewrite ^/api/v1/(.*)$ /v1/$1 break;
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
    proxy_connect_timeout 15s;
    client_max_body_size 100M;
    
    add_header X-API-Version "v1" always;
  }

  # Voice cloning API endpoint - FIXED to point to june-tts
  location /api/v1/voice-clone {
    rewrite ^/api/v1/(.*)$ /v1/$1 break;
    proxy_pass https://june-tts-359243954.us-central1.run.app;  # FIXED
    proxy_ssl_server_name on;
    proxy_set_header Host june-tts-359243954.us-central1.run.app;  # FIXED
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout 300s;
    proxy_connect_timeout 15s;
    client_max_body_size 100M;
    
    add_header X-API-Version "v1" always;
    add_header X-Feature "voice-cloning" always;
  }

  # ---- Error pages ----
  error_page 404 /404.html;
  location = /404.html {
    internal;
    default_type text/html;
    return 404 '<!DOCTYPE html>
<html><head><title>404 Not Found</title></head>
<body><h1>404 Not Found</h1>
<p>The requested resource was not found on this server.</p>
<p><small>nginx-edge/fixed-tts-v1</small></p></body></html>';
  }

  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    internal;
    default_type text/html;
    return 500 '<!DOCTYPE html>
<html><head><title>Service Unavailable</title></head>
<body><h1>Service Temporarily Unavailable</h1>
<p>Please try again later.</p>
<p><small>nginx-edge/fixed-tts-v1</small></p></body></html>';
  }

  # ---- Default/Landing page ----
  location = / {
    default_type text/html;
    return 200 '<!DOCTYPE html>
<html><head><title>June AI Voice Assistant</title></head>
<body>
<h1>June AI Voice Assistant</h1>
<p>Powered by Coqui TTS with emotion control and voice cloning.</p>
<p>Available endpoints:</p>
<ul>
  <li><a href="/healthz">/healthz</a> - Health check</li>
  <li><a href="/realms/june">/realms/june</a> - Authentication</li>
  <li>/orchestrator/ - AI Orchestrator</li>
  <li>/tts/ - Text-to-Speech (Coqui TTS)</li>
  <li>/stt/ - Speech-to-Text</li>
  <li>/api/v1/ - API Gateway</li>
</ul>
<p><small>nginx-edge/fixed-tts-v1 | Coqui TTS Engine</small></p>
</body></html>';
  }

  # Catch-all for unmatched paths
  location / {
    default_type text/html;
    return 404 '<!DOCTYPE html>
<html><head><title>Path Not Found</title></head>
<body><h1>Path Not Found</h1>
<p>Available endpoints:</p>
<ul>
  <li><a href="/healthz">/healthz</a> - Health check</li>
  <li><a href="/realms/june">/realms/june</a> - Authentication</li>
  <li>/orchestrator/ - AI Orchestrator with emotion detection</li>
  <li>/tts/ - TTS (emotion control + voice cloning)</li>
  <li>/stt/ - Speech-to-Text</li>
  <li>/api/v1/ - API Gateway endpoints</li>
</ul>
<p><strong>TTS Features:</strong></p>
<ul>
  <li>üé≠ Emotion control and exaggeration</li>
  <li>üé§ Voice cloning with reference audio</li>
  <li>üåç Multilingual support (23 languages)</li>
  <li>‚ö° Sub-200ms inference time</li>
  <li>üõ°Ô∏è Neural watermarking</li>
</ul>
<p><small>nginx-edge/fixed-tts-v1 | Powered by Coqui TTS</small></p>
</body></html>';
  }
}