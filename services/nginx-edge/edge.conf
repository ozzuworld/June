# --- HTTP-level tweaks (valid here because conf.d is included inside http {}) ---
# WebSocket upgrade helper (if you need WS for STT/TTS)
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# Optional: redirect behavior (can be set here or in server)
absolute_redirect off;

# --- Your server ---
server {
  listen 0.0.0.0:8080;
  server_name _;

  add_header X-Edge nginx-edge always;

  # Health: /healthz, /health, /_ah/health (with optional slash)
  location ~ ^/(healthz|health|_ah/health)/?$ {
    access_log off;
    default_type text/plain;
    return 200 "ok\n";
  }

  # Keycloak (modern)
  location /realms/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  location /admin/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Keycloak legacy shim (/auth/* -> /*)
  location /auth/ {
    rewrite ^/auth/(.*)$ /$1 break;
    proxy_pass https://june-idp-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Orchestrator (note trailing slash)
  location /orchestrator/ {
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # STT (if used)
  location /stt/ {
    proxy_pass https://june-stt-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-stt-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Uncomment if you actually use WS/streaming:
    # proxy_set_header Upgrade    $http_upgrade;
    # proxy_set_header Connection $connection_upgrade;
    # proxy_read_timeout 600s; proxy_send_timeout 600s;
  }

  # TTS (if used)
  location /tts/ {
    proxy_pass https://june-tts-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-tts-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Landing page
  location = / { return 302 /realms/june; }
}
