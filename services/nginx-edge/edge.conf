# services/nginx-edge/edge.conf
# This file is included inside the stock http {} via: include /etc/nginx/conf.d/*.conf;

# (http-level tweaks allowed here)
absolute_redirect off;

# If you'll do WebSockets later, uncomment below:
# map $http_upgrade $connection_upgrade { default upgrade; '' close; }

server {
  listen 0.0.0.0:8080;
  server_name _;

  # Tag responses so you can see they came from this edge
  add_header X-Edge nginx-edge always;

  # ---- Health (bullet-proof) ----
  # Matches /healthz, /health, /_ah/health with or without trailing slash
  location ~ ^/(healthz|health|_ah/health)/?$ {
    access_log off;
    default_type text/plain;
    return 200 "ok\n";
  }
  # Exact (highest precedence)
  location = /healthz {
    access_log off;
    default_type text/plain;
    return 200 "ok\n";
  }

  # Debug: proves this file is the one running (remove later if you want)
  location = /__edge_dump {
    access_log off;
    default_type text/plain;
    return 200 "edge-conf-live:v1\n";
  }

  # ---- Keycloak (modern paths) ----
  location /realms/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
  location /admin/ {
    proxy_pass https://june-idp-359243954.us-central1.run.app$request_uri;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ---- Keycloak legacy shim (/auth/* -> /*) ----
  location /auth/ {
    rewrite ^/auth/(.*)$ /$1 break;
    proxy_pass https://june-idp-359243954.us-central1.run.app;
    proxy_ssl_server_name on;
    proxy_set_header Host june-idp-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ---- Orchestrator ----
  # Trailing slash makes /orchestrator/foo -> upstream /foo
  location /orchestrator/ {
    proxy_pass https://june-orchestrator-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-orchestrator-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ---- STT (if used) ----
  location /stt/ {
    proxy_pass https://june-stt-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-stt-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # For WS/streaming later:
    # proxy_set_header Upgrade    $http_upgrade;
    # proxy_set_header Connection $connection_upgrade;
    # proxy_read_timeout 600s; proxy_send_timeout 600s;
  }

  # ---- TTS (if used) ----
  location /tts/ {
    proxy_pass https://june-tts-359243954.us-central1.run.app/;
    proxy_ssl_server_name on;
    proxy_set_header Host june-tts-359243954.us-central1.run.app;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ---- Landing page ----
  location = / { return 302 /realms/june; }
}
