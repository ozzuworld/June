version: "3.9"

services:
  june-tts:
    image: ghcr.io/ozzuworld/june-tts:latest
    container_name: june-tts
    restart: unless-stopped
    environment:
      - TTS_PORT=${TTS_PORT:-8000}
      - TTS_HOME=/app/models
      - NUMBA_DISABLE_JIT=1
      - NUMBA_CACHE_DIR=/tmp/numba_cache
      - PYTORCH_JIT=0
      - OMP_NUM_THREADS=1
      - TAILSCALE_AUTH_KEY=${TAILSCALE_AUTH_KEY}
      - TAILSCALE_HOSTNAME=${TAILSCALE_HOSTNAME:-june-tts}
    volumes:
      - tts-models:/app/models
      - tts-cache:/app/cache
      - /var/lib/tailscale:/var/lib/tailscale
    ports:
      - "${TTS_PORT:-8000}:8000"
    networks:
      - june-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  june-stt:
    image: ghcr.io/ozzuworld/june-stt:latest
    container_name: june-stt
    restart: unless-stopped
    environment:
      - STT_PORT=${STT_PORT:-8001}
      - WHISPER_DEVICE=cuda
      - WHISPER_COMPUTE_TYPE=float16
      - NUMBA_DISABLE_JIT=1
      - NUMBA_CACHE_DIR=/tmp/numba_cache
      - TAILSCALE_AUTH_KEY=${TAILSCALE_AUTH_KEY}
      - TAILSCALE_HOSTNAME=${TAILSCALE_HOSTNAME:-june-stt}
    volumes:
      - stt-models:/app/models
      - stt-cache:/app/cache
      - /var/lib/tailscale:/var/lib/tailscale
    ports:
      - "${STT_PORT:-8001}:8001"
    networks:
      - june-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale-coordinator
    restart: unless-stopped
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SOCKET=/var/run/tailscale/tailscaled.sock
      - TS_USERSPACE=true
    volumes:
      - /var/lib/tailscale:/var/lib/tailscale
      - /var/run/tailscale:/var/run/tailscale
    networks:
      - june-network
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

volumes:
  tts-models:
    driver: local
  tts-cache:
    driver: local
  stt-models:
    driver: local
  stt-cache:
    driver: local

networks:
  june-network:
    driver: bridge