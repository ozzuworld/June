name: ğŸš€ Build and Push to Docker Hub

on:
  push:
    branches: [ master ]
    paths:
      - 'June/services/**'
  
  workflow_dispatch:
    inputs:
      services:
        description: 'ğŸ“¦ Services to build (comma-separated: june-orchestrator,june-stt,june-tts,june-dark or leave empty for all)'
        required: false
        type: string
        default: ''
      build_all:
        description: 'ğŸ”¨ Build all services'
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Detect changed services
      if: github.event_name == 'push'
      id: changed-files
      uses: tj-actions/changed-files@v47
      with:
        files_yaml: |
          orchestrator:
            - June/services/june-orchestrator/**
          stt:
            - June/services/june-stt/**
          tts:
            - June/services/june-tts/**
          dark:
            - June/services/june-dark/**
    
    - name: ğŸ“‹ Set matrix for changed services
      id: set-matrix
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # Manual trigger logic
          if [[ "${{ inputs.build_all }}" == "true" ]]; then
            echo "ğŸ”¨ Building all services"
            echo "matrix=[\"june-orchestrator\",\"june-stt\",\"june-tts\",\"june-dark\"]" >> $GITHUB_OUTPUT
          elif [[ -n "${{ inputs.services }}" ]]; then
            echo "ğŸ¯ Building selected services: ${{ inputs.services }}"
            SERVICES="${{ inputs.services }}"
            SERVICES_JSON=$(echo "$SERVICES" | jq -R -s -c 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$";""))')
            echo "matrix=$SERVICES_JSON" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”¨ No specific services selected, building all"
            echo "matrix=[\"june-orchestrator\",\"june-stt\",\"june-tts\",\"june-dark\"]" >> $GITHUB_OUTPUT
          fi
        else
          # Push event - build only changed services
          SERVICES=()
          if [[ "${{ steps.changed-files.outputs.orchestrator_any_changed }}" == "true" ]]; then
            echo "ğŸ¼ june-orchestrator changed"
            SERVICES+=("june-orchestrator")
          fi
          if [[ "${{ steps.changed-files.outputs.stt_any_changed }}" == "true" ]]; then
            echo "ğŸ¤ june-stt changed"
            SERVICES+=("june-stt")
          fi
          if [[ "${{ steps.changed-files.outputs.tts_any_changed }}" == "true" ]]; then
            echo "ğŸ”Š june-tts changed"
            SERVICES+=("june-tts")
          fi
          if [[ "${{ steps.changed-files.outputs.dark }}" == "true" ]]; then
            echo "ğŸ­ june-dark changed"
            SERVICES+=("june-dark")
          fi
          
          if [ ${#SERVICES[@]} -eq 0 ]; then
            echo "âš ï¸ No services changed, building all as fallback"
            echo "matrix=[\"june-orchestrator\",\"june-stt\",\"june-tts\",\"june-dark\"]" >> $GITHUB_OUTPUT
          else
            echo "âœ… Building ${#SERVICES[@]} changed service(s)"
            MATRIX_JSON=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
        fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ozzuworld/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=sha-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: ğŸ³ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./June/services/${{ matrix.service }}
        file: ./June/services/${{ matrix.service }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        
    - name: âœ… Build complete
      run: |
        echo "âœ… Successfully built and pushed ${{ matrix.service }}"
        echo "ğŸ“¦ Tags: ${{ steps.meta.outputs.tags }}"
