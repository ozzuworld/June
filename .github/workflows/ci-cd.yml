name: CI/CD Pipeline

on:
  workflow_dispatch:

env:
  REGISTRY: docker.io/${{ secrets.DOCKERHUB_USERNAME }}
  KUBE_NAMESPACE: june
  IMAGE_TAG: latest

permissions:
  contents: read

jobs:
  # 1. Build & Push Images in parallel
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [june-stt, june-tts, june-orchestrator, june-idp]
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push ${{ matrix.service }}
        run: |
          docker build -t $REGISTRY/${{ matrix.service }}:$IMAGE_TAG \
            June/services/${{ matrix.service }}
          docker push $REGISTRY/${{ matrix.service }}:$IMAGE_TAG

  # 2. Deploy to Kubernetes
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # ✅ ADD THIS STEP - Checkout repository to access k8s manifests
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decode Kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > kubeconfig
          chmod 600 kubeconfig

      # ✅ IMPROVED - Verify files exist before applying
      - name: Verify Kubernetes manifests
        run: |
          echo "Verifying k8s manifest files exist..."
          ls -la k8s/
          for file in namespace.yaml configmap.yaml secrets.yaml june-stt-deployment.yaml june-tts-deployment.yaml june-orchestrator-deployment.yaml june-idp-deployment.yaml ingress.yaml; do
            if [ -f "k8s/$file" ]; then
              echo "✅ k8s/$file exists"
            else
              echo "❌ k8s/$file NOT FOUND"
              exit 1
            fi
          done

      - name: Apply Kubernetes Manifests
        env:
          KUBECONFIG: kubeconfig
        run: |
          # Apply in logical order
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secrets.yaml
          kubectl apply -f k8s/june-stt-deployment.yaml
          kubectl apply -f k8s/june-tts-deployment.yaml
          kubectl apply -f k8s/june-orchestrator-deployment.yaml
          kubectl apply -f k8s/june-idp-deployment.yaml
          kubectl apply -f k8s/ingress.yaml

  # 3. Smoke Tests  
  smoke-test:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Decode Kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > kubeconfig
          chmod 600 kubeconfig

      - name: Wait for Deployments
        env:
          KUBECONFIG: kubeconfig
        run: |
          for svc in june-stt june-tts june-orchestrator june-idp; do
            kubectl rollout status deployment/$svc -n june --timeout=2m
          done
