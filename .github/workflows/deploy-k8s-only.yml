name: ğŸš€ Deploy Only (No Build)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      services:
        description: 'Services to deploy (comma-separated, empty for all)'
        required: false
        default: ''
        type: string
      force_restart:
        description: 'Force restart deployments'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io/${{ secrets.DOCKERHUB_USERNAME }}
  KUBE_NAMESPACE: june
  IMAGE_TAG: ${{ github.event.inputs.image_tag }}

permissions:
  contents: read

jobs:
  deploy:
    name: ğŸ”§ Deploy to Kubernetes
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Kubernetes Context
        run: |
          echo "ğŸ”§ Setting up Kubernetes context..."
          export KUBECONFIG=/root/.kube/config
          echo "KUBECONFIG=/root/.kube/config" >> $GITHUB_ENV
          kubectl config current-context
          echo "âœ… Kubernetes context configured"

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Label nodes for GPU scheduling
        run: |
          echo "ğŸ·ï¸ Labeling nodes..."
          kubectl label nodes --all gpu=true --overwrite || echo "Label already exists"
          echo "âœ… Nodes labeled"

      - name: ğŸ—ï¸ Ensure namespace exists
        run: |
          echo "ğŸ—ï¸ Ensuring namespace exists..."
          kubectl apply -f k8s/namespace.yaml
          echo "âœ… Namespace applied"

      - name: ğŸ—„ï¸ Create required storage directories
        run: |
          echo "ğŸ—„ï¸ Creating storage directories on nodes..."
          sudo mkdir -p /opt/june-stt-models /opt/june-tts-models /opt/june-data
          sudo chmod 777 /opt/june-stt-models /opt/june-tts-models /opt/june-data
          echo "âœ… Storage directories created"

      - name: ğŸš€ Enable GPU Time-Slicing
        run: |
          echo "ğŸš€ Configuring GPU time-slicing..."
          
          # Create time-slicing config
          cat << 'EOF' | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: time-slicing-config
            namespace: gpu-operator
          data:
            any: |-
              version: v1
              flags:
                migStrategy: none
              sharing:
                timeSlicing:
                  resources:
                  - name: nvidia.com/gpu
                    replicas: 2
          EOF
          
          # Patch cluster policy to enable time-slicing
          kubectl patch clusterpolicy/cluster-policy -n gpu-operator --type merge -p '{
            "spec": {
              "devicePlugin": {
                "config": {
                  "name": "time-slicing-config",
                  "default": "any"
                }
              }
            }
          }'
          
          echo "âœ… GPU time-slicing configuration applied"

      - name: ğŸ” Create/Update Docker Registry Secret
        run: |
          echo "ğŸ” Creating Docker Hub secret..."
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --docker-email=${{ secrets.DOCKERHUB_EMAIL }} \
            --namespace=$KUBE_NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Docker Hub secret created/updated"

      - name: ğŸ” Verify connection
        run: |
          echo "ğŸ” Testing Kubernetes connection..."
          kubectl cluster-info
          kubectl get nodes
          kubectl get namespaces | grep june
          echo "âœ… Connection verified"

      - name: âœ… Verify manifests exist
        run: |
          echo "ğŸ” Verifying k8s manifest files..."
          ls -la k8s/
          
          REQUIRED_FILES=(
            "namespace.yaml"
            "configmap.yaml" 
            "secrets.yaml"
            "storage.yaml"
            "june-stt-deployment.yaml"
            "june-tts-deployment.yaml"
            "june-orchestrator-deployment.yaml"
            "june-idp-deployment.yaml"
            "ingress.yaml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "k8s/$file" ]; then
              echo "âœ… k8s/$file exists"
            else
              echo "âŒ k8s/$file NOT FOUND"
              exit 1
            fi
          done

      - name: ğŸ”§ Update image tags in manifests
        run: |
          echo "ğŸ”§ Updating image tags to: $IMAGE_TAG"
          
          # Update image tags in deployment files
          for service in june-stt june-tts june-orchestrator june-idp; do
            if [ -f "k8s/${service}-deployment.yaml" ]; then
              sed -i "s|image: $REGISTRY/${service}:.*|image: $REGISTRY/${service}:$IMAGE_TAG|g" k8s/${service}-deployment.yaml
              echo "âœ… Updated ${service} to use tag: $IMAGE_TAG"
            fi
          done

      - name: ğŸ—ƒï¸ Apply storage configuration
        run: |
          echo "ğŸ—ƒï¸ Applying storage resources..."
          kubectl apply -f k8s/storage.yaml
          echo "âœ… Storage configuration applied"
          
          # Wait for PVs to be available
          echo "â³ Waiting for Persistent Volumes to be available..."
          kubectl get pv
          echo "â³ Waiting for Persistent Volume Claims to bind..."
          kubectl get pvc -n $KUBE_NAMESPACE
          echo "âœ… Storage resources ready"

      - name: ğŸ—ï¸ Apply base configuration
        run: |
          echo "ğŸ—ï¸ Applying base Kubernetes resources..."
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secrets.yaml
          echo "âœ… Base configuration applied"

      - name: â³ Wait for GPU time-slicing to take effect
        run: |
          echo "â³ Waiting for GPU device plugin to restart..."
          sleep 30
          
          # Check GPU capacity
          GPU_COUNT=$(kubectl get nodes -o json | jq '.items[].status.allocatable."nvidia.com/gpu"' | tr -d '"')
          echo "ğŸ” Available GPU slots: $GPU_COUNT"
          
          if [ "$GPU_COUNT" != "2" ]; then
            echo "âš ï¸ GPU time-slicing may still be applying, continuing with deployment..."
          else
            echo "âœ… GPU time-slicing active with 2 slots"
          fi

      - name: ğŸš€ Deploy services
        run: |
          echo "ğŸš€ Deploying services..."
          
          SERVICES_INPUT="${{ github.event.inputs.services }}"
          ALL_SERVICES=("june-stt" "june-tts" "june-orchestrator" "june-idp")
          
          if [ -z "$SERVICES_INPUT" ]; then
            echo "ğŸ“‹ Deploying all services..."
            SERVICES_TO_DEPLOY=("${ALL_SERVICES[@]}")
          else
            echo "ğŸ“‹ Deploying selected services: $SERVICES_INPUT"
            IFS=',' read -ra SERVICES_TO_DEPLOY <<< "$SERVICES_INPUT"
          fi
          
          for service in "${SERVICES_TO_DEPLOY[@]}"; do
            service=$(echo "$service" | xargs)
            if [ -f "k8s/${service}-deployment.yaml" ]; then
              echo "ğŸ”„ Deploying ${service}..."
              kubectl apply -f "k8s/${service}-deployment.yaml"
              echo "âœ… ${service} deployed"
            else
              echo "âš ï¸ Warning: k8s/${service}-deployment.yaml not found"
            fi
          done

      - name: ğŸŒ Apply ingress
        run: |
          echo "ğŸŒ Applying ingress configuration..."
          kubectl apply -f k8s/ingress.yaml
          echo "âœ… Ingress applied"

      - name: ğŸ”„ Force restart (if requested)
        if: github.event.inputs.force_restart == 'true'
        run: |
          echo "ğŸ”„ Force restarting deployments..."
          kubectl rollout restart deployment -n $KUBE_NAMESPACE
          echo "âœ… Deployments restarted"

      - name: â³ Wait for deployments
        run: |
          echo "â³ Waiting for deployments to be ready..."
          
          SERVICES_INPUT="${{ github.event.inputs.services }}"
          ALL_SERVICES=("june-stt" "june-tts" "june-orchestrator" "june-idp")
          
          if [ -z "$SERVICES_INPUT" ]; then
            SERVICES_TO_CHECK=("${ALL_SERVICES[@]}")
          else
            IFS=',' read -ra SERVICES_TO_CHECK <<< "$SERVICES_INPUT"
          fi
          
          for service in "${SERVICES_TO_CHECK[@]}"; do
            service=$(echo "$service" | xargs)
            echo "â³ Waiting for $service to be ready..."
            if kubectl get deployment "$service" -n $KUBE_NAMESPACE >/dev/null 2>&1; then
              kubectl rollout status deployment/"$service" -n $KUBE_NAMESPACE --timeout=600s || {
                echo "âŒ $service deployment failed or timed out"
                echo "ğŸ” Deployment details:"
                kubectl describe deployment "$service" -n $KUBE_NAMESPACE
                echo "ğŸ” Pod details:"
                kubectl describe pods -l app="$service" -n $KUBE_NAMESPACE
                echo "ğŸ” Pod logs:"
                kubectl logs -l app="$service" -n $KUBE_NAMESPACE --tail=50 || echo "No logs available"
                echo "ğŸ” PVC Status:"
                kubectl get pvc -n $KUBE_NAMESPACE
                echo "ğŸ” GPU Status:"
                kubectl describe nodes | grep -A 5 -B 5 "nvidia.com/gpu"
                exit 1
              }
              echo "âœ… $service is ready"
            else
              echo "âš ï¸ Deployment $service not found, skipping..."
            fi
          done
          
          echo "âœ… All deployments processed!"

      - name: ğŸ“Š Show deployment status
        run: |
          echo "ğŸ“Š Final deployment status:"
          echo "===================="
          echo "Pods:"
          kubectl get pods -n $KUBE_NAMESPACE -o wide
          echo ""
          echo "Services:"
          kubectl get services -n $KUBE_NAMESPACE
          echo ""
          echo "Ingress:"
          kubectl get ingress -n $KUBE_NAMESPACE
          echo ""
          echo "Secrets:"
          kubectl get secrets -n $KUBE_NAMESPACE
          echo ""
          echo "Storage:"
          kubectl get pv
          kubectl get pvc -n $KUBE_NAMESPACE
          echo ""
          echo "GPU Resources:"
          kubectl describe nodes | grep -A 3 -B 1 "nvidia.com/gpu"
          echo "âœ… Deployment completed!"
