# Updated .github/workflows/deploy.yml
# Fix for nginx-edge deployment issues

name: Deploy Services to Cloud Run

on:
  push:
    branches: [ main, master ]
    paths:
      - 'June/services/**'
      - 'services/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: {}

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  AR_REPO: ${{ vars.ARTIFACT_REPO || 'june' }}

jobs:
  # Deploy core services first
  deploy-core:
    name: Deploy Core Services
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: june-idp
            path: services/june-idp
            timeout: 900
            concurrency: 20
            cpu: "2"
            memory: "2Gi"
            min_instances: 1
          - service: june-orchestrator  
            path: June/services/june-orchestrator
            timeout: 3600
            concurrency: 10
            cpu: "1"
            memory: "512Mi"
            min_instances: 0
          - service: june-stt
            path: June/services/june-stt
            timeout: 3600
            concurrency: 1
            cpu: "2"
            memory: "1Gi"
            min_instances: 1
          - service: june-tts
            path: June/services/june-tts
            timeout: 3600
            concurrency: 4
            cpu: "2"
            memory: "1Gi"
            min_instances: 0

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOYER_SA }}
          project_id: ${{ env.PROJECT_ID }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and Deploy
        run: |
          # Build image
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${{ matrix.service }}:${GITHUB_SHA}"
          docker build -t "$IMAGE" "${{ matrix.path }}"
          docker push "$IMAGE"
          
          # Determine service account (match your existing SAs)
          case "${{ matrix.service }}" in
            june-orchestrator) SA="orchestrator-svc" ;;
            june-idp) SA="june-idp-svc" ;;
            june-stt) SA="stt-svc" ;;
            june-tts) SA="tts-svc" ;;
            *) SA="${{ matrix.service }}-svc" ;;
          esac
          
          # Deploy with service-specific config
          if [ "${{ matrix.service }}" = "june-idp" ]; then
            # Keycloak with database config
            gcloud run deploy ${{ matrix.service }} \
              --image="$IMAGE" \
              --region="$REGION" \
              --cpu="${{ matrix.cpu }}" \
              --memory="${{ matrix.memory }}" \
              --min-instances="${{ matrix.min_instances }}" \
              --timeout="${{ matrix.timeout }}" \
              --concurrency="${{ matrix.concurrency }}" \
              --service-account="${SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
              --allow-unauthenticated \
              --set-env-vars="KC_DB=postgres,KC_DB_URL=${{ secrets.KC_DB_URL }},KC_DB_USERNAME=${{ secrets.KC_DB_USERNAME }},KC_BOOTSTRAP_ADMIN_USERNAME=admin,KC_BOOTSTRAP_ADMIN_PASSWORD=bootstrap-temp,KC_HTTP_ENABLED=true,KC_HOSTNAME_STRICT=false,KC_TRANSACTION_XA_ENABLED=false,KC_HOSTNAME=${{ secrets.KC_BASE_URL }}" \
              --set-secrets="KC_DB_PASSWORD=KC_DB_PASSWORD:latest" \
              --args="start,--http-enabled=true,--hostname-strict=false,--proxy-headers=xforwarded,--db=postgres,--transaction-xa-enabled=false"
            
            # Enable session affinity for Keycloak
            gcloud run services update ${{ matrix.service }} \
              --region="$REGION" \
              --session-affinity || true
              
          else
            # Other services with auth config + service URLs for orchestrator
            ENV_VARS="KC_BASE_URL=${{ secrets.KC_BASE_URL }},KC_REALM=${{ secrets.KC_REALM || 'june' }}"
            
            # Add service-to-service URLs for orchestrator
            if [ "${{ matrix.service }}" = "june-orchestrator" ]; then
              ENV_VARS="${ENV_VARS},STT_SERVICE_URL=https://june-stt-359243954.us-central1.run.app"
              ENV_VARS="${ENV_VARS},TTS_SERVICE_URL=https://june-tts-359243954.us-central1.run.app"
              ENV_VARS="${ENV_VARS},ORCHESTRATOR_CLIENT_ID=${{ secrets.ORCHESTRATOR_CLIENT_ID }}"
              ENV_VARS="${ENV_VARS},ORCHESTRATOR_CLIENT_SECRET=${{ secrets.ORCHESTRATOR_CLIENT_SECRET }}"
            fi
            
            # Add service-specific credentials
            if [ "${{ matrix.service }}" = "june-stt" ]; then
              ENV_VARS="${ENV_VARS},STT_CLIENT_ID=${{ secrets.STT_CLIENT_ID }}"
              ENV_VARS="${ENV_VARS},STT_CLIENT_SECRET=${{ secrets.STT_CLIENT_SECRET }}"
            fi
            
            if [ "${{ matrix.service }}" = "june-tts" ]; then
              ENV_VARS="${ENV_VARS},TTS_CLIENT_ID=${{ secrets.TTS_CLIENT_ID }}"
              ENV_VARS="${ENV_VARS},TTS_CLIENT_SECRET=${{ secrets.TTS_CLIENT_SECRET }}"
            fi
            
            gcloud run deploy ${{ matrix.service }} \
              --image="$IMAGE" \
              --region="$REGION" \
              --cpu="${{ matrix.cpu }}" \
              --memory="${{ matrix.memory }}" \
              --min-instances="${{ matrix.min_instances }}" \
              --timeout="${{ matrix.timeout }}" \
              --concurrency="${{ matrix.concurrency }}" \
              --service-account="${SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
              --allow-unauthenticated \
              --set-env-vars="$ENV_VARS"
          fi

      - name: Output URL
        run: |
          URL=$(gcloud run services describe ${{ matrix.service }} --region="$REGION" --format='value(status.uri)')
          echo "🌐 ${{ matrix.service }}: $URL"

  # Deploy nginx-edge after core services - IMPROVED VERSION
  deploy-edge:
    name: Deploy Edge Proxy
    runs-on: ubuntu-latest
    needs: deploy-core
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOYER_SA }}
          project_id: ${{ env.PROJECT_ID }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Deploy nginx-edge
        run: |
          # Build image
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/nginx-edge:${GITHUB_SHA}"
          docker build -t "$IMAGE" "services/nginx-edge"
          docker push "$IMAGE"
          
          echo "🔍 Getting service URLs for nginx-edge..."
          
          # Wait for services to be fully ready
          sleep 15
          
          # Get service URLs using more reliable method
          echo "Listing all services first:"
          gcloud run services list --region="$REGION" --project="$PROJECT_ID" --filter="metadata.name:june"
          
          # Get URLs one by one with error handling
          echo "Getting individual service URLs..."
          
          IDP_URL=""
          ORCH_URL=""
          STT_URL=""
          TTS_URL=""
          
          # Try multiple methods to get URLs
          for attempt in 1 2 3; do
            echo "Attempt $attempt to get service URLs..."
            
            # Method 1: describe service
            if [ -z "$IDP_URL" ]; then
              IDP_URL=$(gcloud run services describe june-idp \
                --region="$REGION" \
                --project="$PROJECT_ID" \
                --format='value(status.uri)' 2>/dev/null || echo "")
            fi
            
            if [ -z "$ORCH_URL" ]; then
              ORCH_URL=$(gcloud run services describe june-orchestrator \
                --region="$REGION" \
                --project="$PROJECT_ID" \
                --format='value(status.uri)' 2>/dev/null || echo "")
            fi
            
            if [ -z "$STT_URL" ]; then
              STT_URL=$(gcloud run services describe june-stt \
                --region="$REGION" \
                --project="$PROJECT_ID" \
                --format='value(status.uri)' 2>/dev/null || echo "")
            fi
            
            if [ -z "$TTS_URL" ]; then
              TTS_URL=$(gcloud run services describe june-tts \
                --region="$REGION" \
                --project="$PROJECT_ID" \
                --format='value(status.uri)' 2>/dev/null || echo "")
            fi
            
            # If we got the critical ones, break
            if [ -n "$IDP_URL" ] && [ -n "$ORCH_URL" ]; then
              break
            fi
            
            echo "Still missing some URLs, waiting 10s..."
            sleep 10
          done
          
          # Debug: Show what we found
          echo "🔍 Service URLs found:"
          echo "  IDP (required): ${IDP_URL:-NOT_FOUND}"
          echo "  ORCH: ${ORCH_URL:-NOT_FOUND}"
          echo "  STT: ${STT_URL:-NOT_FOUND}"
          echo "  TTS: ${TTS_URL:-NOT_FOUND}"
          
          # Verify we have at least IDP (minimum required)
          if [ -z "$IDP_URL" ]; then
            echo "❌ ERROR: Could not get june-idp URL. Cannot deploy nginx-edge."
            echo "Available services:"
            gcloud run services list --region="$REGION" --project="$PROJECT_ID"
            exit 1
          fi
          
          # Build environment variables (IDP required, others optional)
          ENV_VARS="UPSTREAM_IDP=${IDP_URL}"
          
          if [ -n "$ORCH_URL" ]; then
            ENV_VARS="${ENV_VARS},UPSTREAM_ORCH=${ORCH_URL}"
            echo "✅ Added orchestrator upstream"
          else
            echo "⚠️  No orchestrator URL found - /orchestrator routes will not work"
          fi
          
          if [ -n "$STT_URL" ]; then
            ENV_VARS="${ENV_VARS},UPSTREAM_STT=${STT_URL}"
            echo "✅ Added STT upstream"
          else
            echo "⚠️  No STT URL found - /stt routes will not work"
          fi
          
          if [ -n "$TTS_URL" ]; then
            ENV_VARS="${ENV_VARS},UPSTREAM_TTS=${TTS_URL}"
            echo "✅ Added TTS upstream"
          else
            echo "⚠️  No TTS URL found - /tts routes will not work"
          fi
          
          echo "🚀 Final environment variables: $ENV_VARS"
          
          # Deploy nginx-edge with improved configuration
          gcloud run deploy nginx-edge \
            --project="$PROJECT_ID" \
            --image="$IMAGE" \
            --region="$REGION" \
            --cpu="1" \
            --memory="512Mi" \
            --min-instances="0" \
            --max-instances="10" \
            --timeout="300" \
            --concurrency="100" \
            --service-account="nginx-edge-svc@${PROJECT_ID}.iam.gserviceaccount.com" \
            --allow-unauthenticated \
            --set-env-vars="$ENV_VARS" \
            --port="8080"

      - name: Test nginx-edge deployment
        run: |
          # Get nginx-edge URL
          EDGE_URL=$(gcloud run services describe nginx-edge \
            --region="$REGION" \
            --project="$PROJECT_ID" \
            --format='value(status.uri)')
          
          echo "🧪 Testing nginx-edge deployment..."
          echo "   URL: $EDGE_URL"
          
          # Test basic connectivity
          if curl -f -s "${EDGE_URL}/healthz" > /dev/null; then
            echo "✅ nginx-edge health check passed"
          else
            echo "❌ nginx-edge health check failed"
          fi
          
          # Test Keycloak routing
          if curl -f -s "${EDGE_URL}/auth/realms/june" > /dev/null; then
            echo "✅ Keycloak routing working"
          else
            echo "⚠️  Keycloak routing may have issues"
          fi

      - name: Output Edge URL and next steps
        run: |
          URL=$(gcloud run services describe nginx-edge --region="$REGION" --format='value(status.uri)')
          echo "🌐 nginx-edge: $URL"
          echo ""
          echo "🎯 Test your routing:"
          echo "   Health: $URL/healthz"
          echo "   Keycloak: $URL/auth/realms/june"
          echo "   Orchestrator: $URL/orchestrator/healthz"
          echo "   STT: $URL/stt/healthz"
          echo "   TTS: $URL/tts/healthz"
          echo ""
          echo "::notice title=Edge Proxy URL::$URL"