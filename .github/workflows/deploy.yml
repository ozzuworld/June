name: Deploy june-idp only

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]
    paths:
      - 'June/services/june-idp/**'
      - 'services/june-idp/**'
      - '.github/workflows/deploy-idp.yml'

defaults:
  run:
    shell: bash

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  AR_REPO: ${{ vars.ARTIFACT_REPO }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOYER_SA }}
          project_id: ${{ env.PROJECT_ID }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Resolve Dockerfile
        id: r
        run: |
          set -euo pipefail
          if [[ -f "services/june-idp/Dockerfile" ]]; then DF="services/june-idp/Dockerfile";
          elif [[ -f "June/services/june-idp/Dockerfile" ]]; then DF="June/services/june-idp/Dockerfile";
          else DF="$(find . -type f -path "*/june-idp/Dockerfile" | head -n1 || true)"; fi
          [[ -n "$DF" ]] || { echo "No june-idp Dockerfile"; exit 1; }
          echo "df=$DF" >> "$GITHUB_OUTPUT"
          echo "wd=$(dirname "$DF")" >> "$GITHUB_OUTPUT"

      - name: Build & push
        run: |
          set -euo pipefail
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/june-idp:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"
          docker build --pull -t "$IMAGE" -f "${{ steps.r.outputs.df }}" "${{ steps.r.outputs.wd }}"
          docker push "$IMAGE"

      - name: Ensure KC_DB_PASSWORD version
        env:
          KC_DB_PASSWORD: ${{ secrets.KC_DB_PASSWORD }}
        run: |
          set -euo pipefail
          [[ -n "${KC_DB_PASSWORD:-}" ]] || { echo "::error ::Missing KC_DB_PASSWORD"; exit 1; }
          gcloud secrets describe KC_DB_PASSWORD --project "${PROJECT_ID}" --format='get(name)' >/dev/null 2>&1 || { echo "::error ::Secret not found"; exit 1; }
          printf '%s' "$KC_DB_PASSWORD" | gcloud secrets versions add KC_DB_PASSWORD --project "${PROJECT_ID}" --data-file=- >/dev/null

      - name: Deploy
        env:
          ARGS_BASE: start,--http-enabled=true,--proxy-headers=xforwarded
        run: |
          set -euo pipefail
          EXTRA="--cpu=2 --memory=2Gi --concurrency=20 --min-instances=1 --service-account=june-idp-svc@${PROJECT_ID}.iam.gserviceaccount.com --set-secrets KC_DB_PASSWORD=KC_DB_PASSWORD:latest"
          gcloud run deploy june-idp --project="${PROJECT_ID}" --image="$IMAGE" --region="${REGION}" --platform=managed --timeout=3600 --allow-unauthenticated $EXTRA --args="${ARGS_BASE}"

      - name: URL
        run: |
          URL="$(gcloud run services describe june-idp --project "${PROJECT_ID}" --region "${REGION}" --format='value(status.uri)')"
          echo "::notice title=Keycloak URL::${URL}"
