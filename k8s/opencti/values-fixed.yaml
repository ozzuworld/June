# OpenCTI Production Configuration - CORRECTED Storage & MinIO Config
# Deploy with: helm upgrade --install opencti opencti/opencti -n opencti -f k8s/opencti/values-fixed.yaml --timeout 25m --wait

opencti:
  enabled: true
  baseUrl: https://opencti.ozzu.world
  admin:
    email: admin@ozzu.world
    password: "OpenCTI2024!"  # MUST NOT be "ChangeMe"
    token: ""                 # Set via bootstrap-admin.sh - MUST be UUIDv4
  server:
    extraEnv:
      - name: ELASTICSEARCH__URL
        value: "http://opensearch-cluster-master:9200"
      # CRITICAL FIX: MinIO endpoint must be hostname only, no protocol/port
      - name: MINIO__ENDPOINT
        value: "opencti-minio"
      - name: MINIO__PORT
        value: "9000"
      - name: MINIO__USE_SSL
        value: "false"
      - name: MINIO__ACCESS_KEY
        value: "opencti"
      - name: MINIO__SECRET_KEY
        value: "MinIO2024!"
      - name: MINIO__BUCKET_NAME
        value: "opencti-bucket"
      # Service names must match Helm chart outputs
      - name: RABBITMQ__HOSTNAME
        value: "opencti-rabbitmq"
      - name: RABBITMQ__USERNAME
        value: "opencti"
      - name: RABBITMQ__PASSWORD
        value: "RabbitMQ2024!"
      - name: RABBITMQ__PORT
        value: "5672"
      - name: REDIS__HOSTNAME
        value: "opencti-redis"
      - name: REDIS__PORT
        value: "6379"
      - name: REDIS__MODE
        value: "single"

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: opencti.ozzu.world
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - opencti.ozzu.world
      secretName: ozzu-world-wildcard-tls

# Use default storage class for portability
# Override with --set global.storageClass=your-class if needed
global:
  storageClass: ""  # Empty string uses cluster default

# OpenSearch Configuration (replaces Elasticsearch)
opensearch:
  enabled: true
  singleNode: true
  opensearchJavaOpts: "-Xms512m -Xmx512m"
  extraEnvs:
    - name: DISABLE_SECURITY_PLUGIN
      value: "true"
    - name: DISABLE_INSTALL_DEMO_CONFIG
      value: "true"
    # Disable attachment processor (not needed for basic setup)
    - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
      value: "OpenSearch2024!"
  persistence:
    enabled: true
    # Uses global.storageClass if not specified
    size: 20Gi
  resources:
    requests:
      cpu: "300m"
      memory: "1Gi"
    limits:
      cpu: "1000m"
      memory: "2Gi"

redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      # Uses global.storageClass if not specified
      size: 5Gi
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "512Mi"

rabbitmq:
  enabled: true
  auth:
    username: opencti
    password: "RabbitMQ2024!"
  persistence:
    enabled: true
    # Uses global.storageClass if not specified
    size: 10Gi
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

minio:
  enabled: true
  mode: standalone
  auth:
    rootUser: opencti
    rootPassword: "MinIO2024!"
  # CRITICAL: Default bucket creation
  defaultBuckets: "opencti-bucket"
  persistence:
    enabled: true
    # Uses global.storageClass if not specified
    size: 50Gi
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "300m"
      memory: "512Mi"