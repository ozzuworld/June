# OpenCTI Production Configuration - CORRECTED MinIO Config
# Deploy with: helm upgrade --install opencti opencti/opencti -n opencti -f k8s/opencti/values-fixed.yaml --timeout 25m --wait

opencti:
  enabled: true
  baseUrl: https://opencti.ozzu.world
  admin:
    email: admin@ozzu.world
    password: "OpenCTI2024!"
    token: ""
  server:
    extraEnv:
      - name: ELASTICSEARCH__URL
        value: "http://opensearch-cluster-master:9200"
      # CRITICAL FIX: MinIO URL must include http:// protocol
      - name: MINIO__ENDPOINT
        value: "http://opencti-minio:9000"
      - name: MINIO__PORT
        value: "9000"
      - name: MINIO__USE_SSL
        value: "false"
      - name: MINIO__ACCESS_KEY
        value: "opencti"
      - name: MINIO__SECRET_KEY
        value: "MinIO2024!"
      - name: MINIO__BUCKET_NAME
        value: "opencti-bucket"

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: opencti.ozzu.world
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - opencti.ozzu.world
      secretName: ozzu-world-wildcard-tls

global:
  storageClass: local-storage

# OpenSearch Configuration (replaces Elasticsearch)
opensearch:
  enabled: true
  singleNode: true
  opensearchJavaOpts: "-Xms512m -Xmx512m"
  extraEnvs:
    - name: DISABLE_SECURITY_PLUGIN
      value: "true"
    - name: DISABLE_INSTALL_DEMO_CONFIG
      value: "true"
    # Disable attachment processor (not needed for basic setup)
    - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
      value: "OpenSearch2024!"
  persistence:
    enabled: true
    storageClass: local-storage
    size: 20Gi
  resources:
    requests:
      cpu: "300m"
      memory: "1Gi"
    limits:
      cpu: "1000m"
      memory: "2Gi"

redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      storageClass: local-storage
      size: 5Gi
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "512Mi"

rabbitmq:
  enabled: true
  auth:
    username: opencti
    password: "RabbitMQ2024!"
  persistence:
    enabled: true
    storageClass: local-storage
    size: 10Gi
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

minio:
  enabled: true
  mode: standalone
  auth:
    rootUser: opencti
    rootPassword: "MinIO2024!"
  # CRITICAL: Default bucket creation
  defaultBuckets: "opencti-bucket"
  persistence:
    enabled: true
    storageClass: local-storage
    size: 50Gi
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "300m"
      memory: "512Mi"