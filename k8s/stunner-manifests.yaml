# STUNner STUN/TURN Server Kubernetes Manifests for June Services
# FIXED VERSION - Uses reliable coturn image with hostNetwork for bare metal K8s
# This configuration ensures TURN/STUN server works correctly every time

---
# STUNner Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: stunner
  labels:
    name: stunner
    app.kubernetes.io/part-of: june

---
# STUNner Authentication Secret
apiVersion: v1
kind: Secret
metadata:
  name: stunner-auth-secret
  namespace: stunner
type: Opaque
stringData:
  username: "STUNNER_USERNAME_PLACEHOLDER"
  password: "STUNNER_PASSWORD_PLACEHOLDER"
  type: "static"

---
# STUNner Deployment - FIXED: Uses coturn instead of stunner operator
apiVersion: apps/v1
kind: Deployment
metadata:
  name: june-stunner-gateway
  namespace: stunner
  labels:
    app: stunner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: stunner
  template:
    metadata:
      labels:
        app: stunner
    spec:
      # CRITICAL: Use hostNetwork for bare metal deployments
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      
      # Ensure STUNner runs on the control plane node
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      
      containers:
      - name: stunner
        # FIXED: Use stable coturn image instead of problematic stunner
        image: coturn/coturn:4.6.2-alpine
        imagePullPolicy: IfNotPresent
        
        # TURN server configuration
        command:
        - turnserver
        - -n                                    # No daemon mode
        - -a                                   # Use long-term authentication
        - -v                                   # Verbose logging
        - -f                                   # Use config file format
        - -L
        - "0.0.0.0"                           # Listen on all interfaces
        - -p
        - "3478"                              # TURN port
        - -r
        - "STUNNER_REALM_PLACEHOLDER"         # Realm (will be replaced)
        - -u
        - "STUNNER_USERNAME_PLACEHOLDER:STUNNER_PASSWORD_PLACEHOLDER"  # User:pass
        - --no-dtls                           # Disable DTLS
        - --no-tls                            # Disable TLS
        - --min-port=49152                    # RTP port range start
        - --max-port=65535                    # RTP port range end
        - --pidfile=/tmp/turnserver.pid       # PID file location
        
        ports:
        - containerPort: 3478
          protocol: UDP
          name: turn-udp
        - containerPort: 3478
          protocol: TCP
          name: turn-tcp
        
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        # Health checks
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "netstat -ulnp | grep :3478 || ss -ulnp | grep :3478"
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
        
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "netstat -ulnp | grep :3478 || ss -ulnp | grep :3478"
          initialDelaySeconds: 15
          periodSeconds: 30
          timeoutSeconds: 3

---
# STUNner Service
apiVersion: v1
kind: Service
metadata:
  name: june-stunner-gateway
  namespace: stunner
  labels:
    app: stunner
spec:
  type: ClusterIP
  selector:
    app: stunner
  ports:
  - port: 3478
    targetPort: 3478
    protocol: UDP
    name: turn-udp
  - port: 3478
    targetPort: 3478
    protocol: TCP
    name: turn-tcp

---
# ConfigMap for TURN server configuration (if needed for advanced config)
apiVersion: v1
kind: ConfigMap
metadata:
  name: stunner-config
  namespace: stunner
data:
  turnserver.conf: |
    # TURN server configuration
    listening-port=3478
    tls-listening-port=5349
    
    # Authentication
    lt-cred-mech
    use-auth-secret
    static-auth-secret=STUNNER_PASSWORD_PLACEHOLDER
    
    # Realm
    realm=STUNNER_REALM_PLACEHOLDER
    
    # Logging
    verbose
    
    # Network
    no-loopback-peers
    no-multicast-peers
    
    # Security
    stale-nonce=600
    
    # Ports
    min-port=49152
    max-port=65535