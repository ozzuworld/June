# STUNner Gateway API Configuration - FIXED API VERSIONS + JANUS INTEGRATION
# Compatible with Gateway API v1.0.0 and STUNner operator
# https://docs.l7mp.io/en/latest/

---
# GatewayConfig: Core STUNner configuration (STUNner CRD)
apiVersion: stunner.l7mp.io/v1
kind: GatewayConfig
metadata:
  name: stunner-gatewayconfig
  namespace: stunner-system
spec:
  realm: "turn.ozzu.world"
  authType: plaintext
  userName: "june-user"
  password: "Pokemon123!"
  logLevel: "all:INFO"

---
# GatewayClass: Links Gateway to STUNner operator (Gateway API v1)
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: stunner-gatewayclass
spec:
  controllerName: "stunner.l7mp.io/gateway-operator"
  parametersRef:
    group: stunner.l7mp.io
    kind: GatewayConfig
    name: stunner-gatewayconfig
    namespace: stunner-system
  description: "STUNner Gateway for June WebRTC Services"

---
# Gateway: The actual TURN server (Gateway API v1)
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: june-stunner-gateway
  namespace: stunner
  annotations:
    stunner.l7mp.io/service-type: LoadBalancer
spec:
  gatewayClassName: stunner-gatewayclass
  listeners:
  # UDP listener for STUN/TURN
  - name: udp-listener
    port: 3478
    protocol: UDP
    allowedRoutes:
      namespaces:
        from: All
  # TCP listener for TURN-TCP (optional but recommended)
  - name: tcp-listener
    port: 3478
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: All

---
# ReferenceGrant: Allow cross-namespace access (Gateway API v1beta1)
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: stunner-to-june-services
  namespace: june-services
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: UDPRoute
    namespace: stunner
  to:
  - group: ""
    kind: Service

---
# UDPRoute: Routes traffic to June orchestrator (STUNner CRD)
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-orchestrator-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-orchestrator
      namespace: june-services
      port: 8080

---
# UDPRoute: Janus WebRTC Gateway (STUNner CRD)
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-janus-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-janus
      namespace: june-services
      port: 8080

---
# UDPRoute: STT service (STUNner CRD)
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-stt-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-stt
      namespace: june-services
      port: 8080

---
# UDPRoute: TTS service (STUNner CRD)
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-tts-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-tts
      namespace: june-services
      port: 8000