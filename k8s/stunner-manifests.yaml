# STUNner Gateway API Configuration - CORRECTED
# Based on official STUNner documentation
# https://docs.l7mp.io/en/latest/

---
# GatewayConfig: Core STUNner configuration
apiVersion: gateway.networking.k8s.io/v1  # ✅ New
kind: GatewayConfig
metadata:
  name: stunner-gatewayconfig
  namespace: stunner-system
spec:
  realm: STUNNER_REALM_PLACEHOLDER
  authType: static
  userName: STUNNER_USERNAME_PLACEHOLDER
  password: STUNNER_PASSWORD_PLACEHOLDER
  logLevel: all:INFO

---
# GatewayClass: Links Gateway to STUNner operator
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: GatewayClass
metadata:
  name: stunner-gatewayclass
spec:
  controllerName: "stunner.l7mp.io/gateway-operator"
  parametersRef:
    group: stunner.l7mp.io
    kind: GatewayConfig
    name: stunner-gatewayconfig
    namespace: stunner-system
  description: "STUNner Gateway for June WebRTC Services"

---
# Gateway: The actual TURN server (operator creates deployment)
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: Gateway
metadata:
  name: june-stunner-gateway
  namespace: stunner
  annotations:
    stunner.l7mp.io/service-type: LoadBalancer
    stunner.l7mp.io/enable-mixed-protocol-lb: "true"
    # ✅ MetalLB specific annotation
    metallb.universe.tf/address-pool: june-pool
spec:
  gatewayClassName: stunner-gatewayclass
  listeners:
  # ✅ UDP listener for STUN/TURN
  - name: udp-listener
    port: 3478
    protocol: UDP
    allowedRoutes:
      namespaces:
        from: All
  # ✅ TCP listener for TURN-TCP (optional but recommended)
  - name: tcp-listener
    port: 3478
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: All

---
# ReferenceGrant: Allow cross-namespace access from stunner to june-services
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: ReferenceGrant
metadata:
  name: stunner-to-june-services
  namespace: june-services
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: UDPRoute
    namespace: stunner
  to:
  - group: ""
    kind: Service

---
# UDPRoute: Routes traffic to June orchestrator
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: UDPRoute
metadata:
  name: june-orchestrator-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - kind: Service
      name: june-orchestrator
      namespace: june-services
      port: 8080

---
# UDPRoute: STT service
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: UDPRoute
metadata:
  name: june-stt-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - kind: Service
      name: june-stt
      namespace: june-services
      port: 8080

---
# UDPRoute: TTS service
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: UDPRoute
metadata:
  name: june-tts-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - kind: Service
      name: june-tts
      namespace: june-services
      port: 8000