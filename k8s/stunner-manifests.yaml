# STUNner Gateway API Configuration (Operator-Managed)
# This file is applied AFTER the operator is installed
# The operator creates the actual TURN server deployment

---
# GatewayConfig: Core STUNner configuration
apiVersion: stunner.l7mp.io/v1
kind: GatewayConfig
metadata:
  name: stunner-gatewayconfig
  namespace: stunner-system
spec:
  realm: STUNNER_REALM_PLACEHOLDER
  authType: static
  userName: STUNNER_USERNAME_PLACEHOLDER
  password: STUNNER_PASSWORD_PLACEHOLDER
  logLevel: all:INFO

---
# GatewayClass: Links Gateway to STUNner operator
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: stunner-gatewayclass
spec:
  controllerName: "stunner.l7mp.io/gateway-operator"
  parametersRef:
    group: "stunner.l7mp.io"
    kind: GatewayConfig
    name: stunner-gatewayconfig
    namespace: stunner-system
  description: "STUNner Gateway for June WebRTC Services"

---
# Gateway: The actual TURN server (operator creates deployment)
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: june-stunner-gateway
  namespace: stunner
  annotations:
    stunner.l7mp.io/service-type: LoadBalancer
    stunner.l7mp.io/service-annotations: |
      metallb.universe.tf/address-pool: june-pool
spec:
  gatewayClassName: stunner-gatewayclass
  listeners:
  - name: udp-listener
    port: 3478
    protocol: UDP
    allowedRoutes:
      namespaces:
        from: All
  - name: tcp-listener
    port: 3478
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: All

---
# UDPRoute: Routes traffic to June services
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-orchestrator-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-orchestrator
      namespace: june-services
      port: 8080

---
# UDPRoute: STT service
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-stt-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-stt
      namespace: june-services
      port: 8080

---
# UDPRoute: TTS service
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
  name: june-tts-route
  namespace: stunner
spec:
  parentRefs:
  - name: june-stunner-gateway
    namespace: stunner
  rules:
  - backendRefs:
    - name: june-tts
      namespace: june-services
      port: 8000