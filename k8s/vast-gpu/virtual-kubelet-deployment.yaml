# Virtual Kubelet deployment for Vast.ai integration
apiVersion: apps/v1
kind: Deployment
metadata:
  name: virtual-kubelet-vast
  namespace: kube-system
  labels:
    app: virtual-kubelet-vast
spec:
  replicas: 1
  selector:
    matchLabels:
      app: virtual-kubelet-vast
  template:
    metadata:
      labels:
        app: virtual-kubelet-vast
    spec:
      serviceAccountName: virtual-kubelet-vast
      nodeSelector:
        kubernetes.io/arch: amd64
      containers:
      - name: virtual-kubelet
        image: your-registry/virtual-kubelet-vast:latest
        env:
        - name: KUBELET_PORT
          value: "10250"
        - name: APISERVER_CERT_LOCATION
          value: "/etc/kubernetes/certs"
        - name: APISERVER_KEY_LOCATION
          value: "/etc/kubernetes/certs"
        - name: VKUBELET_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NODENAME
          value: "vast-gpu-node-1"
        - name: VAST_API_KEY
          valueFrom:
            secretKeyRef:
              name: vast-credentials
              key: api-key
        - name: VAST_API_URL
          value: "https://console.vast.ai/api/v0"
        - name: CLUSTER_DOMAIN
          value: "cluster.local"
        - name: ORCHESTRATOR_URL
          valueFrom:
            configMapKeyRef:
              name: june-config
              key: orchestrator-url
        volumeMounts:
        - name: credentials
          mountPath: /etc/virtual-kubelet
          readOnly: true
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /stats/summary
            port: 10255
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /stats/summary  
            port: 10255
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: credentials
        secret:
          secretName: vast-credentials
      tolerations:
      - key: node.alpha.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 0
      - key: node.alpha.kubernetes.io/not-ready
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 0