# Virtual Kubelet deployment for Vast.ai integration - North America Optimized
apiVersion: apps/v1
kind: Deployment
metadata:
  name: virtual-kubelet-vast
  namespace: kube-system
  labels:
    app: virtual-kubelet-vast
    region: north-america
spec:
  replicas: 1
  selector:
    matchLabels:
      app: virtual-kubelet-vast
  template:
    metadata:
      labels:
        app: virtual-kubelet-vast
        region: north-america
    spec:
      serviceAccountName: virtual-kubelet-vast
      nodeSelector:
        kubernetes.io/arch: amd64
      containers:
      - name: virtual-kubelet
        image: your-registry/virtual-kubelet-vast:latest
        env:
        # Kubelet configuration
        - name: KUBELET_PORT
          value: "10250"
        - name: APISERVER_CERT_LOCATION
          value: "/etc/kubernetes/certs"
        - name: APISERVER_KEY_LOCATION
          value: "/etc/kubernetes/certs"
        - name: VKUBELET_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NODENAME
          value: "vast-gpu-node-na-1"  # North America node identifier
        
        # Vast.ai API configuration
        - name: VAST_API_KEY
          valueFrom:
            secretKeyRef:
              name: vast-credentials
              key: api-key
        - name: VAST_API_URL
          value: "https://console.vast.ai/api/v0"
        
        # North America optimization settings
        - name: VAST_PREFERRED_REGIONS
          value: "US-CA,US-WA,US-OR,US-TX,US-CO,US-AZ,US-NY,US-FL,US-VA,CA-ON,CA-BC"
        - name: VAST_PRIMARY_REGION
          value: "US"
        - name: VAST_FALLBACK_REGIONS
          value: "CA,MX"
        - name: VAST_BLOCKED_REGIONS
          value: "RU,CN,KP"  # Blocked countries
        
        # Instance selection criteria from config.env
        - name: VAST_GPU_TYPE
          valueFrom:
            configMapKeyRef:
              name: june-config
              key: vast-gpu-type
              optional: true
        - name: VAST_MAX_PRICE_PER_HOUR
          valueFrom:
            configMapKeyRef:
              name: june-config
              key: vast-max-price
              optional: true
        - name: VAST_MIN_RELIABILITY
          valueFrom:
            configMapKeyRef:
              name: june-config
              key: vast-reliability
              optional: true
        
        # Service configuration
        - name: CLUSTER_DOMAIN
          value: "cluster.local"
        - name: ORCHESTRATOR_URL
          valueFrom:
            configMapKeyRef:
              name: june-config
              key: orchestrator-url
        
        # Performance optimization
        - name: VAST_LATENCY_CHECK_ENABLED
          value: "true"
        - name: VAST_MAX_LATENCY_MS
          value: "50"  # 50ms max for North America
        - name: VAST_BANDWIDTH_MIN_MBPS
          value: "100"
        
        # Template configuration
        - name: VAST_CONTAINER_IMAGE
          value: "your-registry/june-gpu-multi:latest"
        - name: VAST_DOCKER_OPTIONS
          value: "-p 8000:8000 -p 8001:8001 --gpus all --restart unless-stopped"
        
        volumeMounts:
        - name: credentials
          mountPath: /etc/virtual-kubelet
          readOnly: true
        - name: provider-config
          mountPath: /etc/vast-config
          readOnly: true
        
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        
        livenessProbe:
          httpGet:
            path: /stats/summary
            port: 10255
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /stats/summary
            port: 10255
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        # Startup probe for initial API connectivity
        startupProbe:
          httpGet:
            path: /healthz
            port: 10255
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 12  # 60 seconds total
      
      volumes:
      - name: credentials
        secret:
          secretName: vast-credentials
      - name: provider-config
        configMap:
          name: vast-provider-config
      
      tolerations:
      - key: node.alpha.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 0
      - key: node.alpha.kubernetes.io/not-ready
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 0
      
      # Prefer to run on control plane nodes
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
      
      # Restart policy for reliability
      restartPolicy: Always