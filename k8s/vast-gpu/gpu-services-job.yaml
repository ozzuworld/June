# Vast.ai GPU Services - Schedule only on Virtual Kubelet node (Job-based to avoid pod spam)
apiVersion: batch/v1
kind: Job
metadata:
  name: june-gpu-provision
  namespace: default
  labels:
    app: june-gpu-multi
spec:
  backoffLimit: 5            # Stop after 5 failed attempts
  activeDeadlineSeconds: 1800 # Give up after 30 minutes
  template:
    metadata:
      labels:
        app: june-gpu-multi
    spec:
      restartPolicy: Never     # Prevent infinite restart loops
      nodeSelector:
        provider: vast.ai
        node.kubernetes.io/instance-type: gpu
      tolerations:
      - key: vast.ai/gpu
        operator: Exists
        effect: NoSchedule
      - key: virtual-kubelet.io/provider
        operator: Equal
        value: vast
        effect: NoSchedule
      - key: node.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 300
      - key: node.kubernetes.io/unreachable
        operator: Exists
        effect: NoSchedule
      containers:
      - name: june-gpu-multi
        image: ozzuworld/june-gpu-multi:latest
        ports:
        - containerPort: 8000
        - containerPort: 8001
        envFrom:
        - secretRef:
            name: june-gpu-secrets
        - configMapRef:
            name: june-config
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
            nvidia.com/gpu: 1
          limits:
            cpu: 2000m
            memory: 4Gi
            nvidia.com/gpu: 1
---
# Keep Services to front june-gpu-multi pods launched via Job
apiVersion: v1
kind: Service
metadata:
  name: june-tts
  namespace: default
  labels:
    app: june-gpu-services
spec:
  selector:
    app: june-gpu-multi
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: june-stt
  namespace: default
  labels:
    app: june-gpu-services
spec:
  selector:
    app: june-gpu-multi
  ports:
  - name: http
    port: 8001
    targetPort: 8001
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: june-gpu-services-headless
  namespace: default
  labels:
    app: june-gpu-services
spec:
  selector:
    app: june-gpu-multi
  clusterIP: None
  ports:
  - name: tts
    port: 8000
    targetPort: 8000
  - name: stt
    port: 8001
    targetPort: 8001
