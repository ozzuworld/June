---
# GPU Time-Slicing Configuration for NVIDIA GPU Operator
# This enables sharing a single GPU between multiple pods
apiVersion: v1
kind: ConfigMap
metadata:
  name: time-slicing-config
  namespace: gpu-operator
  labels:
    app.kubernetes.io/name: june
    app.kubernetes.io/component: gpu-config
data:
  any: |-
    version: v1
    flags:
      migStrategy: none
    sharing:
      timeSlicing:
        resources:
        - name: nvidia.com/gpu
          replicas: 2

---
# Script to apply GPU time-slicing configuration
# This patches the cluster policy to enable time-slicing
apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-config-script
  namespace: june-services
  labels:
    app.kubernetes.io/name: june
    app.kubernetes.io/component: gpu-config
data:
  enable-gpu-sharing.sh: |
    #!/bin/bash
    echo "🚀 Enabling GPU time-slicing..."
    
    # Apply time-slicing config
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: time-slicing-config
      namespace: gpu-operator
    data:
      any: |-
        version: v1
        flags:
          migStrategy: none
        sharing:
          timeSlicing:
            resources:
            - name: nvidia.com/gpu
              replicas: 2
    EOF
    
    # Patch cluster policy
    kubectl patch clusterpolicy/cluster-policy -n gpu-operator --type merge -p '{
      "spec": {
        "devicePlugin": {
          "config": {
            "name": "time-slicing-config",
            "default": "any"
          }
        }
      }
    }'
    
    echo "✅ GPU time-slicing configuration applied"
    echo "⏳ Waiting for device plugin to restart..."
    
    # Wait for changes to take effect
    sleep 30
    
    # Verify GPU capacity
    GPU_COUNT=$(kubectl get nodes -o json | jq '.items[].status.allocatable."nvidia.com/gpu"' | tr -d '"')
    echo "🔍 Available GPU slots: $GPU_COUNT"
    
    if [ "$GPU_COUNT" = "2" ]; then
      echo "✅ GPU time-slicing successfully enabled!"
    else
      echo "⚠️ GPU time-slicing may still be applying..."
    fi
