---
# 1. ClusterIssuer for Let's Encrypt (Staging for testing)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Staging server (for testing - no rate limits)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: your-email@example.com  # CHANGE THIS
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: nginx

---
# 2. ClusterIssuer for Let's Encrypt (Production)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Production server (use after staging works)
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com  # CHANGE THIS
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx

---
# 3. Ingress with TLS configured
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: june-platform-ingress
  namespace: june
  annotations:
    # Specify ingress class
    kubernetes.io/ingress.class: nginx
    
    # cert-manager annotations (START WITH STAGING!)
    cert-manager.io/cluster-issuer: letsencrypt-staging  # Change to letsencrypt-prod after testing
    
    # ACME challenge configuration
    acme.cert-manager.io/http01-edit-in-place: "true"
    
    # SSL configuration
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # CORS and other settings
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    
spec:
  tls:
  - hosts:
    - api.allsafe.world
    - auth.allsafe.world
    - stt.allsafe.world
    - tts.allsafe.world
    secretName: june-tls-secret
  
  rules:
  # API / Orchestrator
  - host: api.allsafe.world
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: june-orchestrator
            port:
              number: 8080
  
  # Identity Provider (Keycloak)
  - host: auth.allsafe.world
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: june-idp
            port:
              number: 8080
  
  # Speech-to-Text
  - host: stt.allsafe.world
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: june-stt
            port:
              number: 8000
  
  # Text-to-Speech
  - host: tts.allsafe.world
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: june-tts
            port:
              number: 8000

---
# 4. Test Certificate (create manually to debug)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: june-tls-test
  namespace: june
spec:
  secretName: june-tls-test-secret
  issuerRef:
    name: letsencrypt-staging
    kind: ClusterIssuer
  dnsNames:
  - api.allsafe.world
  # Test with ONE domain first