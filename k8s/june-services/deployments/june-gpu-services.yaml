apiVersion: apps/v1
kind: Deployment
metadata:
  name: june-gpu-services
  namespace: june-services
  labels:
    app: june-gpu-services
    component: gpu-services
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: june-gpu-services
  template:
    metadata:
      labels:
        app: june-gpu-services
        component: gpu-services
      annotations:
        vast.ai/image: ozzuworld/june-multi-gpu:latest
        vast.ai/gpu-type: RTX 4060
        vast.ai/gpu-fallbacks: RTX 3060,RTX 3060 Ti,RTX 4060 Ti,RTX 4070,RTX 3070,RTX 3080,RTX 3090,RTX A5000
        vast.ai/price-max: "0.90"
        vast.ai/region: North America
        vast.ai/disk: "50"
        vast.ai/env: -p 8000:8000 -p 8001:8001
        vast.ai/onstart-cmd: >-
          pip install -q fastapi uvicorn aiohttp && echo 'Container ready for June services'
    spec:
      nodeName: vast-gpu-node-python
      tolerations:
      - key: vast.ai/gpu
        operator: Exists
        effect: NoSchedule
      - key: virtual-kubelet.io/provider
        operator: Equal
        value: vast
        effect: NoSchedule
      restartPolicy: Always
      terminationGracePeriodSeconds: 60
      volumes:
      - name: models-cache
        emptyDir:
          sizeLimit: 10Gi
      - name: temp-cache
        emptyDir:
          sizeLimit: 5Gi
      - name: tailscale-state
        emptyDir:
          sizeLimit: 100Mi
      containers:
      - name: june-multi-gpu
        image: ozzuworld/june-multi-gpu:latest
        imagePullPolicy: Always
        ports:
        - name: tts-api
          containerPort: 8000
        - name: stt-api
          containerPort: 8001
        env:
        - name: STT_PORT
          value: "8001"
        - name: TTS_PORT
          value: "8000"
        - name: CUDA_VISIBLE_DEVICES
          value: "0"
        - name: WHISPER_DEVICE
          value: cuda
        - name: WHISPER_COMPUTE_TYPE
          value: float16
        - name: TTS_CACHE_PATH
          value: /app/cache
        - name: TTS_HOME
          value: /app/models
        - name: COQUI_TOS_AGREED
          value: "1"
        - name: ORCHESTRATOR_URL
          value: http://june-orchestrator:8080
        - name: LIVEKIT_WS_URL
          value: ws://livekit:7880
        - name: LIVEKIT_HTTP_URL
          value: http://livekit:7880
        - name: ROOM_NAME
          value: ozzu-main
        - name: LIVEKIT_API_KEY
          valueFrom:
            secretKeyRef:
              name: june-secrets
              key: livekit-api-key
              optional: true
        - name: LIVEKIT_API_SECRET
          valueFrom:
            secretKeyRef:
              name: june-secrets
              key: livekit-api-secret
              optional: true
        - name: BEARER_TOKEN
          valueFrom:
            secretKeyRef:
              name: june-secrets
              key: bearer-token
              optional: true
        resources:
          requests:
            cpu: "4"
            memory: 12Gi
            nvidia.com/gpu: "1"
          limits:
            cpu: "8"
            memory: 16Gi
            nvidia.com/gpu: "1"
        securityContext:
          privileged: false
          capabilities:
            add: ["NET_ADMIN", "NET_RAW"]
        volumeMounts:
        - name: models-cache
          mountPath: /app/models
        - name: temp-cache
          mountPath: /app/cache
        - name: tailscale-state
          mountPath: /var/lib/tailscale
