---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opencti-connector-config
  namespace: june-dark
data:
  CONNECTOR_ID: "june-dark-opencti-connector"
  CONNECTOR_NAME: "June Dark OSINT"
  CONNECTOR_SCOPE: "osint,threat-intelligence,enrichment"
  CONNECTOR_VERSION: "1.0.0"
  CONNECTOR_CONFIDENCE_LEVEL: "75"
  CONNECTOR_LOG_LEVEL: "INFO"

  # OpenCTI connection (will be set from OpenCTI credentials)
  OPENCTI_SSL_VERIFY: "true"

  # June Dark RabbitMQ
  RABBITMQ_URL: "amqp://juneadmin:juneR@bbit2024@rabbitmq.june-dark:5672//"
  RABBITMQ_QUEUE: "enrichment.results"
  RABBITMQ_EXCHANGE: "june.enrichment"

  # Processing settings
  BATCH_SIZE: "10"
  BATCH_TIMEOUT: "30"
  MAX_TLP: "TLP:AMBER"

  # Indicator creation rules
  CREATE_INDICATORS: "true"
  CREATE_OBSERVABLES: "true"
  CREATE_NOTES: "true"
  CREATE_REPORTS: "true"

  # Entity mapping
  MAP_URLS_AS_OBSERVABLES: "true"
  MAP_IPS_AS_OBSERVABLES: "true"
  MAP_DOMAINS_AS_OBSERVABLES: "true"
  MAP_EMAILS_AS_OBSERVABLES: "true"
  MAP_ALERTS_AS_INCIDENTS: "true"

  # Author and source
  AUTHOR_NAME: "June Dark OSINT Framework"
  SOURCE_NAME: "June Dark"

  # Performance
  WORKERS: "2"
  PREFETCH_COUNT: "10"

---
apiVersion: v1
kind: Secret
metadata:
  name: opencti-connector-secret
  namespace: june-dark
type: Opaque
stringData:
  # This will be populated from OpenCTI credentials
  OPENCTI_URL: "https://dark.ozzu.world"
  OPENCTI_TOKEN: "REPLACE_WITH_OPENCTI_TOKEN"

---
apiVersion: v1
kind: Service
metadata:
  name: opencti-connector
  namespace: june-dark
spec:
  ports:
    - port: 8000
      targetPort: 8000
  selector:
    app: opencti-connector

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opencti-connector
  namespace: june-dark
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opencti-connector
  template:
    metadata:
      labels:
        app: opencti-connector
    spec:
      enableServiceLinks: false  # Prevent K8s service env vars from interfering with app config
      containers:
        - name: connector
          image: ozzuworld/june-dark-opencti-connector:latest
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: opencti-connector-config
            - secretRef:
                name: opencti-connector-secret
          ports:
            - containerPort: 8000
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
