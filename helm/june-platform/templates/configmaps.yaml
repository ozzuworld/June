# helm/june-platform/templates/configmaps.yaml
---
# General application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: june-config
  namespace: {{ .Release.Namespace }}
data:
  APP_ENV: {{ .Values.global.environment }}
  LOG_LEVEL: info
  REGION: us-central1

---
# Janus Gateway configuration (Updated for custom TURN/STUN)
apiVersion: v1
kind: ConfigMap
metadata:
  name: june-janus-config
  namespace: {{ .Release.Namespace }}
data:
  # Janus connection info for orchestrator admin API only
  JANUS_HTTP_URL: "http://june-janus.{{ .Release.Namespace }}.svc.cluster.local:8088"
  JANUS_ADMIN_URL: "http://june-janus.{{ .Release.Namespace }}.svc.cluster.local:8089"
  
  # Client-facing Janus endpoints
  JANUS_PUBLIC_WS_URL: "wss://{{ .Values.domains.primary }}/janus-ws"
  JANUS_PUBLIC_HTTP_URL: "https://{{ .Values.domains.primary }}/janus"
  
  {{- if .Values.janus.turn.enabled }}
  # Custom TURN/STUN configuration (Your own server)
  STUN_SERVER: "{{ .Values.janus.turn.server }}:{{ .Values.janus.turn.port }}"
  TURN_SERVER: "{{ .Values.janus.turn.server }}:{{ .Values.janus.turn.port }}"
  TURN_USERNAME: {{ .Values.janus.turn.username | quote }}
  TURN_CREDENTIAL: {{ .Values.janus.turn.password | quote }}
  {{- else }}
  # Fallback to STUNner configuration if custom TURN is disabled
  STUN_SERVER: "{{ .Values.domains.turn }}:3478"
  TURN_SERVER: "{{ .Values.domains.turn }}:3478"
  TURN_USERNAME: {{ .Values.stunner.username | quote }}
  TURN_CREDENTIAL: {{ .Values.stunner.password | quote }}
  {{- end }}

---
# Client configuration (Updated for custom TURN/STUN)
apiVersion: v1
kind: ConfigMap
metadata:
  name: june-client-config
  namespace: {{ .Release.Namespace }}
data:
  # WebRTC configuration for clients
  webrtc_config.json: |
    {
      "janus": {
        "ws_url": "wss://{{ .Values.domains.primary }}/janus-ws",
        "http_url": "https://{{ .Values.domains.primary }}/janus"
      },
      "ice_servers": [
        {{- if .Values.janus.turn.enabled }}
        {
          "urls": ["stun:{{ .Values.janus.turn.server }}:{{ .Values.janus.turn.port }}"]
        },
        {
          "urls": ["turn:{{ .Values.janus.turn.server }}:{{ .Values.janus.turn.port }}"],
          "username": "{{ .Values.janus.turn.username }}",
          "credential": "{{ .Values.janus.turn.password }}"
        }
        {{- else }}
        {
          "urls": ["stun:{{ .Values.domains.turn }}:3478"]
        },
        {
          "urls": ["turn:{{ .Values.domains.turn }}:3478"],
          "username": "{{ .Values.stunner.username }}",
          "credential": "{{ .Values.stunner.password }}"
        }
        {{- end }}
      ]
    }