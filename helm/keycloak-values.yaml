# Bitnami Keycloak Helm Chart Values
# Official chart: https://github.com/bitnami/charts/tree/main/bitnami/keycloak
# Version: Compatible with Keycloak 26.x via Bitnami chart

# Global configuration
global:
  storageClass: "fast-ssd"

# Keycloak configuration
auth:
  adminUser: admin
  adminPassword: Pokemon123!  # CHANGE IN PRODUCTION

# Production mode
production: true

# Proxy configuration (behind Ingress/Traefik)
# Required for production mode when behind reverse proxy
proxyHeaders: xforwarded

# PostgreSQL configuration (bundled)
postgresql:
  enabled: true
  # Use chart's default PostgreSQL image (Bitnami handles versioning)
  auth:
    username: keycloak
    password: Pokemon123!  # CHANGE IN PRODUCTION
    database: keycloak
  primary:
    persistence:
      enabled: true
      storageClass: fast-ssd
      size: 10Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# Option 2: Use existing PostgreSQL (uncomment to use existing DB)
# postgresql:
#   enabled: false
# externalDatabase:
#   host: postgresql.june-services.svc.cluster.local
#   port: 5432
#   user: keycloak
#   password: Pokemon123!
#   database: keycloak

# Keycloak pod configuration
replicaCount: 1

# Image configuration - Use Bitnami image (required for Bitnami chart)
# Note: Bitnami images are available on Docker Hub but chart handles rate limiting better
# Alternatively, you can mirror to your own registry
image:
  registry: docker.io
  repository: bitnami/keycloak
  tag: "26.0.4"
  pullPolicy: IfNotPresent

resources:
  requests:
    memory: "1Gi"
    cpu: "500m"
  limits:
    memory: "2Gi"
    cpu: "1000m"

# Health checks - Bitnami chart format
livenessProbe:
  enabled: true
  initialDelaySeconds: 120
  periodSeconds: 20
  timeoutSeconds: 10
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

# Startup probe for slow-starting containers
startupProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Metrics (Prometheus integration)
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    interval: 30s

# Ingress configuration
ingress:
  enabled: true
  ingressClassName: traefik
  hostname: idp.ozzu.world
  tls: true
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

# Extra environment variables for Keycloak
# Note: Bitnami handles most KC_* vars automatically from chart values
extraEnvVars:
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_PROXY_HEADERS
    value: "xforwarded"

# Note: extraStartupArgs removed - Bitnami chart uses different startup mechanism
# The chart automatically configures database, health, and metrics from values

# Service configuration
service:
  type: ClusterIP
  ports:
    http: 8080

# Pod security context
podSecurityContext:
  enabled: true
  fsGroup: 1000

containerSecurityContext:
  enabled: true
  runAsUser: 1000
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Logging
logging:
  level: INFO
