# Bitnami Keycloak Helm Chart Values
# Official chart: https://github.com/bitnami/charts/tree/main/bitnami/keycloak
# Version: Compatible with Keycloak 26.x via Bitnami chart

# Global configuration
global:
  storageClass: "fast-ssd"

# Keycloak configuration
auth:
  adminUser: admin
  adminPassword: Pokemon123!  # CHANGE IN PRODUCTION

# Production mode
production: true

# Proxy configuration (behind Ingress/Traefik)
proxy: edge

# PostgreSQL configuration (bundled)
postgresql:
  enabled: true
  auth:
    username: keycloak
    password: Pokemon123!  # CHANGE IN PRODUCTION
    database: keycloak
  primary:
    persistence:
      enabled: true
      storageClass: fast-ssd
      size: 10Gi
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# Option 2: Use existing PostgreSQL (uncomment to use existing DB)
# postgresql:
#   enabled: false
# externalDatabase:
#   host: postgresql.june-services.svc.cluster.local
#   port: 5432
#   user: keycloak
#   password: Pokemon123!
#   database: keycloak

# Keycloak pod configuration
replicaCount: 1

# Image configuration (uses Quay.io - no Docker Hub rate limiting)
image:
  registry: quay.io
  repository: keycloak/keycloak
  tag: 26.0.4
  pullPolicy: IfNotPresent

resources:
  requests:
    memory: "1Gi"
    cpu: "500m"
  limits:
    memory: "2Gi"
    cpu: "1000m"

# Health checks
livenessProbe:
  enabled: true
  httpGet:
    path: /health/live
    port: http
  initialDelaySeconds: 90
  periodSeconds: 20
  timeoutSeconds: 10
  failureThreshold: 5

readinessProbe:
  enabled: true
  httpGet:
    path: /health/ready
    port: http
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Metrics (Prometheus integration)
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    interval: 30s

# Ingress configuration
ingress:
  enabled: true
  ingressClassName: traefik
  hostname: idp.ozzu.world
  tls: true
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

# Extra environment variables for Keycloak
extraEnvVars:
  - name: KC_HOSTNAME
    value: "idp.ozzu.world"
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KC_METRICS_ENABLED
    value: "true"
  - name: KC_PROXY_HEADERS
    value: "xforwarded"
  - name: KC_DB
    value: "postgres"

# Keycloak startup arguments
extraStartupArgs: "--optimized --db=postgres --health-enabled=true --metrics-enabled=true"

# Service configuration
service:
  type: ClusterIP
  ports:
    http: 8080

# Pod security context
podSecurityContext:
  enabled: true
  fsGroup: 1000

containerSecurityContext:
  enabled: true
  runAsUser: 1000
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Logging
logging:
  level: INFO
